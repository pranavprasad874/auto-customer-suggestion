<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AutoFix Application</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style type="text/tailwindcss">
        :root {
            --primary-color: #2563eb; /* Blue 600 */
            --primary-hover: #1d4ed8; /* Blue 700 */
            --background-color: #f9fafb; /* Gray 50 */
            --card-background: #ffffff;
            --border-color: #e5e7eb; /* Gray 200 */
            --text-primary: #111827; /* Gray 900 */
            --text-secondary: #6b7280; /* Gray 500 */
            --text-on-primary: #ffffff;
        }
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
        }
        .screen { display: none; }
        .active-screen { display: block; }
        .modal-hidden { display: none; }
        
        /* Component Styles */
        .form-input { @apply w-full rounded-lg border-[var(--border-color)] text-base shadow-sm transition-colors focus:border-[var(--primary-color)] focus:ring focus:ring-[var(--primary-color)] focus:ring-opacity-50; }
        .form-label { @apply block text-sm font-medium text-[var(--text-secondary)] mb-1; }
        .btn-primary { @apply w-full flex justify-center items-center gap-2 rounded-lg bg-[var(--primary-color)] text-[var(--text-on-primary)] font-bold py-3 px-4 shadow-sm hover:bg-[var(--primary-hover)] transition-all duration-300 transform hover:scale-[1.02]; }
        .btn-secondary { @apply w-full flex justify-center items-center gap-2 rounded-lg bg-[var(--text-secondary)] text-[var(--text-on-primary)] font-bold py-3 px-4 shadow-sm hover:bg-[var(--text-primary)] transition-colors duration-300 transform hover:scale-[1.02]; }
        .btn-whatsapp { @apply w-full flex justify-center items-center gap-2 rounded-lg bg-[#25D366] text-white font-bold py-3 px-4 shadow-sm hover:bg-[#1DA851] transition-all duration-300 transform hover:scale-[1.02]; }
        .card { @apply bg-[var(--card-background)] p-5 rounded-xl border border-[var(--border-color)] shadow-sm; }
        .app-header { @apply bg-white border-b border-[var(--border-color)] sticky top-0 z-10; }
        .app-header-content { @apply max-w-7xl mx-auto p-4 flex justify-between items-center relative; }
        .app-main { @apply p-4 max-w-7xl mx-auto space-y-6 pb-24; }

        /* Bottom Nav Styling */
        .bottom-nav { @apply fixed bottom-0 left-0 right-0 bg-white border-t border-[var(--border-color)] shadow-[0_-2px_5px_rgba(0,0,0,0.05)]; }
        .nav-item { @apply flex flex-col items-center justify-center flex-1 py-2 gap-1 text-[var(--text-secondary)] transition-colors; }
        .nav-item.active { @apply text-[var(--primary-color)]; }
        .nav-item .material-symbols-outlined { @apply text-2xl; }
        .nav-item span { @apply text-xs font-medium; }

        /* Report Table Styles */
        .table-container { @apply w-full overflow-auto rounded-lg border border-[var(--border-color)] max-h-[70vh]; }
        .report-table { @apply min-w-full divide-y divide-[var(--border-color)]; }
        .report-table th { @apply sticky top-0 bg-gray-50 px-4 py-3 text-left text-xs font-medium text-[var(--text-secondary)] uppercase tracking-wider z-10 whitespace-nowrap; }
        .report-table td { @apply px-4 py-4 whitespace-nowrap text-sm; }
        .report-table tbody tr:nth-child(even) { @apply bg-white; }
        .report-table tbody tr:nth-child(odd) { @apply bg-gray-50; }
        
        /* Styles for the accordion list in Due Date page */
        .due-date-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .due-date-item.expanded .due-date-details {
            max-height: 500px; /* Large enough to fit content */
        }
        .due-date-item.expanded .due-date-header .material-symbols-outlined {
            transform: rotate(180deg);
        }
		/* Styles for Printing */
        .printable-area {
            display: none;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="login-screen" class="screen active-screen">
        <div class="flex flex-col min-h-screen justify-center items-center p-4 bg-gray-50">
            <div class="w-full max-w-sm">
                <div class="flex justify-center items-center gap-3 mb-8"><span class="material-symbols-outlined text-4xl text-[var(--primary-color)]">minor_crash</span><h1 class="text-3xl font-bold tracking-tight text-[var(--text-primary)]">AutoFix</h1></div>
                <div class="card space-y-6">
                    <div class="text-center"><h2 class="text-2xl font-bold text-gray-800">Welcome Back</h2><p class="text-[var(--text-secondary)] mt-1">Please sign in to your account.</p></div>
                    <form onsubmit="event.preventDefault(); login();">
                        <div class="space-y-4">
                            <div><label for="username" class="form-label">Username</label><div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">person</span><input class="form-input pl-10" id="username" placeholder="Enter your username" type="text" /></div></div>
                            <div><label for="password" class="form-label">Password</label><div class="relative"><span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">lock</span><input class="form-input pl-10" id="password" placeholder="Enter your password" type="password" /></div></div>
                        </div>
                        <div class="mt-6">
                            <button type="submit" class="btn-primary">
                              <span class="material-symbols-outlined">login</span>Sign In
                            </button>
                        </div>
                    </form>
                </div>
                 
            </div>
        </div>
    </div>

    <div id="admin-screens" class="screen">
        <div id="admin-dashboard-screen" class="admin-screen active-admin-screen">
             <header class="app-header"><div class="app-header-content"><h1 class="text-2xl font-bold text-[var(--primary-color)] flex-1 text-center">Admin Dashboard</h1><button onclick="logout()" class="absolute right-4 flex items-center gap-2 text-[var(--text-secondary)] hover:text-[var(--primary-color)]"><span class="font-medium text-sm hidden sm:block">Logout</span><span class="material-symbols-outlined">logout</span></button></div></header>
            <main class="app-main grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                
                 <a href="javascript:void(0)" onclick="showAdminScreen('admin-reports-screen')" class="card text-center items-center flex flex-col justify-center transition-all hover:shadow-xl hover:-translate-y-1"><span class="material-symbols-outlined text-5xl text-[var(--primary-color)]">assessment</span><h2 class="text-lg font-bold mt-2">Reports & Service History</h2><p class="text-sm text-[var(--text-secondary)]">View & Filter All Reports</p></a>
                 <a href="javascript:void(0)" onclick="showAdminScreen('admin-analytics-screen')" class="card text-center items-center flex flex-col justify-center transition-all hover:shadow-xl hover:-translate-y-1"><span class="material-symbols-outlined text-5xl text-[var(--primary-color)]">monitoring</span><h2 class="text-lg font-bold mt-2">Analytics</h2><p class="text-sm text-[var(--text-secondary)]">View Complaint & Executive Stats</p></a>
				  <a href="javascript:void(0)" onclick="showAdminScreen('admin-vehicle-management-screen')" class="card text-center items-center flex flex-col justify-center transition-all hover:shadow-xl hover:-translate-y-1"><span class="material-symbols-outlined text-5xl text-[var(--primary-color)]">minor_crash</span><h2 class="text-lg font-bold mt-2">Vehicle Management</h2><p class="text-sm text-[var(--text-secondary)]">Create & Delete Brands/Models</p></a>
                 <a href="javascript:void(0)" onclick="showAdminScreen('admin-executive-management-screen')" class="card text-center items-center flex flex-col justify-center transition-all hover:shadow-xl hover:-translate-y-1"><span class="material-symbols-outlined text-5xl text-[var(--primary-color)]">manage_accounts</span><h2 class="text-lg font-bold mt-2">Executive Management</h2><p class="text-sm text-[var(--text-secondary)]">Create & Delete Executives</p></a>
                 <a href="javascript:void(0)" onclick="showAdminScreen('admin-admin-management-screen')" class="card text-center items-center flex flex-col justify-center transition-all hover:shadow-xl hover:-translate-y-1"><span class="material-symbols-outlined text-5xl text-[var(--primary-color)]">admin_panel_settings</span><h2 class="text-lg font-bold mt-2">Admin Management</h2><p class="text-sm text-[var(--text-secondary)]">Manage Admins & Passwords</p></a>
            </main>
        </div>
        
        <div id="admin-vehicle-management-screen" class="admin-screen" style="display:none;">
            <header class="app-header"><div class="app-header-content"><button class="absolute left-4 text-[var(--text-secondary)] hover:text-[var(--primary-color)]" onclick="showAdminScreen('admin-dashboard-screen')"><span class="material-symbols-outlined">arrow_back_ios_new</span></button><h1 class="text-2xl font-bold text-[var(--primary-color)] flex-1 text-center">Vehicle Management</h1></div></header>
            <main class="app-main">
                <div class="card"><h2 class="text-xl font-bold mb-4">Create New Vehicle Brand & Model</h2><form id="add-vehicle-model-form" onsubmit="event.preventDefault(); addVehicleModel();" class="space-y-4"><input id="new-brand-admin" class="form-input" placeholder="Enter Brand (e.g., Maruti Suzuki)" required /><input id="new-model-admin" class="form-input" placeholder="Enter Model (e.g., Swift)" required /><button type="submit" class="btn-primary"><span class="material-symbols-outlined">add</span>Add Vehicle Model</button></form></div>
                <div class="card space-y-3"><h2 class="text-xl font-bold">Existing Brands & Models</h2><div id="vehicle-models-list"></div></div>
            </main>
        </div>

        <div id="admin-reports-screen" class="admin-screen" style="display: none;">
            <header class="app-header"><div class="app-header-content"><button class="absolute left-4 text-[var(--text-secondary)] hover:text-[var(--primary-color)]" onclick="showAdminScreen('admin-dashboard-screen')"><span class="material-symbols-outlined">arrow_back_ios_new</span></button><h1 class="text-2xl font-bold text-[var(--primary-color)] flex-1 text-center">Admin Reports</h1></div></header>
            <main class="app-main">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Filter Reports</h2>
                    <div id="admin-report-filters" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 items-end">
                        <div class="space-y-1">
    <label for="admin-filter-from-date" class="text-xs font-medium text-gray-500">From Date</label>
    <input type="date" id="admin-filter-from-date" class="form-input" onchange="handleDateChange('admin-filter-from-date', 'admin-filter-to-date'); applyAdminReportFilters();">
</div>
<div class="space-y-1">
    <label for="admin-filter-to-date" class="text-xs font-medium text-gray-500">To Date</label>
    <input type="date" id="admin-filter-to-date" class="form-input" onchange="handleDateChange('admin-filter-from-date', 'admin-filter-to-date'); applyAdminReportFilters();">
</div>
                        
                        <input type="text" id="admin-filter-vehicle-no" class="form-input" placeholder="Vehicle Number" oninput="applyAdminReportFilters()">
                        <input type="text" id="admin-filter-brand" class="form-input" placeholder="Brand" oninput="applyAdminReportFilters()">
                        <input type="text" id="admin-filter-exec-name" class="form-input" placeholder="Executive Name" oninput="applyAdminReportFilters()">
                        <button onclick="clearAdminReportFilters()" class="text-sm h-11 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300">Clear Filters</button>
                    </div>
                </div>
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold">Service History</h2>
    <button onclick="downloadReport()" class="flex items-center gap-1 px-3 py-1 text-sm font-bold text-white bg-green-600 rounded-lg hover:bg-green-700">
        <span class="material-symbols-outlined">download</span>
        Download Report
    </button>
</div>
                    <div class="table-container">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Vehicle No.</th>
                                    <th>Vehicle Name</th>
                                    <th>Model</th>
                                    <th>Brand</th>
                                    <th>Color</th>
                                    <th>Engine No</th>
                                    <th>Chassis No</th>
                                    <th>Client Name</th>
                                    <th>Client Phone</th>
                                    <th>Odometer</th>
                                    <th>Executive</th>
                                    <th>Date & Time</th>
                                    <th>Status</th>
                                    <th>Complaint</th>
                                    <th>Suggested</th>
                                    <th>Approved</th>
                                    <th>Materials Required</th>
                                    <th>Marks</th>
                                    <th>Executive Media</th>
                                    <th>Customer Feedback</th>
                                    <th>Customer Voice Note</th>
                                </tr>
                            </thead>
                            <tbody id="admin-report-table-body"></tbody>
                        </table>
                    </div>
                    <p id="admin-no-reports-message" class="text-center text-gray-500 py-8 hidden">No reports found matching your criteria.</p>
                </div>
            </main>
        </div>

        <div id="admin-analytics-screen" class="admin-screen" style="display: none;">
             <header class="app-header"><div class="app-header-content"><button class="absolute left-4 text-[var(--text-secondary)] hover:text-[var(--primary-color)]" onclick="showAdminScreen('admin-dashboard-screen')"><span class="material-symbols-outlined">arrow_back_ios_new</span></button><h1 class="text-2xl font-bold text-[var(--primary-color)] flex-1 text-center">Analytics</h1></div></header>
             <main class="app-main">
                <div class="card"><h2 class="text-xl font-bold mb-4">Filter Analytics</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><select id="analytics-month-filter" class="form-input" onchange="renderAnalytics()"><option value="">All Months</option></select><select id="analytics-exec-filter" class="form-input" onchange="renderAnalytics()"><option value="">All Executives</option></select></div></div>
                <div class="card space-y-4"><h2 id="analytics-title" class="text-xl font-bold">Overall Complaint Status</h2><div id="analytics-chart"></div></div>
             </main>
        </div>

        <div id="admin-executive-management-screen" class="admin-screen" style="display: none;">
            <header class="app-header"><div class="app-header-content"><button class="absolute left-4 text-[var(--text-secondary)] hover:text-[var(--primary-color)]" onclick="showAdminScreen('admin-dashboard-screen')"><span class="material-symbols-outlined">arrow_back_ios_new</span></button><h1 class="text-2xl font-bold text-[var(--primary-color)] flex-1 text-center">Executive Management</h1></div></header>
            <main class="app-main">
                <div class="card"><h2 class="text-xl font-bold mb-4">Create New Executive</h2><form id="add-exec-form" onsubmit="event.preventDefault(); addUser('executive');" class="space-y-4"><input id="new-exec-username" class="form-input" placeholder="Enter Username" required /><input id="new-exec-pass" class="form-input" placeholder="Enter Password" type="password" required /><button type="submit" class="btn-primary"><span class="material-symbols-outlined">add</span>Create Executive</button></form></div>
                <div class="card space-y-3"><h2 class="text-xl font-bold">Executive List</h2><div id="executives-list"></div></div>
            </main>
        </div>

        <div id="admin-admin-management-screen" class="admin-screen" style="display: none;">
            <header class="app-header"><div class="app-header-content"><button class="absolute left-4 text-[var(--text-secondary)] hover:text-[var(--primary-color)]" onclick="showAdminScreen('admin-dashboard-screen')"><span class="material-symbols-outlined">arrow_back_ios_new</span></button><h1 class="text-2xl font-bold text-[var(--primary-color)] flex-1 text-center">Admin Management</h1></div></header>
            <main class="app-main">
                <div class="card"><h2 class="text-xl font-bold mb-4">Create New Admin</h2><form id="add-admin-form" onsubmit="event.preventDefault(); addUser('admin');" class="space-y-4"><input id="new-admin-username" class="form-input" placeholder="Enter Username" required /><input id="new-admin-pass" class="form-input" placeholder="Enter Password" type="password" required /><button type="submit" class="btn-primary"><span class="material-symbols-outlined">add</span>Create Admin</button></form></div>
                <div class="card space-y-3"><h2 class="text-xl font-bold">Admin List</h2><div id="admins-list"></div></div>
            </main>
        </div>
    </div>

    <div id="executive-screens" class="screen">
        <header class="app-header">
            <div class="app-header-content">
                <h1 id="executive-header-title" class="text-2xl font-bold text-[var(--primary-color)] flex-1 text-center">Job Card</h1>
                <button onclick="logout()" class="absolute right-4 flex items-center gap-2 text-[var(--text-secondary)] hover:text-[var(--primary-color)]">
                    <span class="font-medium text-sm hidden sm:block">Logout</span>
                    <span class="material-symbols-outlined">logout</span>
                </button>
            </div>
        </header>

        <div id="job-card-screen" class="executive-screen active-executive-screen">
             <main class="app-main">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Vehicle No:</h2>
                    <input type="file" id="image-upload-input" class="hidden" accept="image/*" capture="environment" onchange="handleImageUpload(event)">
                    <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
                        <input id="search-vehicle-number" type="text" placeholder="Enter Vehicle Number (e.g., KL07AB1234)" class="form-input flex-grow min-w-0" onkeyup="this.value = this.value.toUpperCase()">
                        <button onclick="document.getElementById('image-upload-input').click()" class="btn-secondary !w-auto flex-shrink-0 !py-2 !px-3">
                            <span class="material-symbols-outlined text-base sm:text-lg">photo_camera</span>
                            <span class="hidden sm:inline text-sm ml-1">Scan</span>
                        </button>
                        <button onclick="searchVehicle()" class="btn-primary !w-auto flex-shrink-0 !py-2 !px-3">
                            <span class="material-symbols-outlined text-base sm:text-lg">search</span>
                            <span class="hidden sm:inline text-sm ml-1">Search</span>
                        </button>
                    </div>
                    <p id="search-error" class="text-red-500 text-sm mt-2 hidden"></p>
                </div>
                
                <div id="vehicle-details-section" class="card hidden space-y-4"><h2 class="text-xl font-bold flex items-center gap-2 text-green-600"><span class="material-symbols-outlined">check_circle</span> Vehicle Found</h2><div class="grid grid-cols-2 gap-x-4 gap-y-3 text-base border-t pt-4">
                    <div><p class="font-medium text-[var(--text-secondary)]">Vehicle Number</p><p id="detail-vehicle-number" class="font-bold text-lg"></p></div>
                    <div><p class="font-medium text-[var(--text-secondary)]">Vehicle Name</p><p id="detail-vehicle-name" class="font-semibold"></p></div>
                    <div><p class="font-medium text-[var(--text-secondary)]">Brand</p><p id="detail-brand" class="font-semibold"></p></div>
                    <div><p class="font-medium text-[var(--text-secondary)]">Model</p><p id="detail-model" class="font-semibold"></p></div>
                    <div><p class="font-medium text-[var(--text-secondary)]">Color</p><p id="detail-color" class="font-semibold"></p></div>
                    <div><p class="font-medium text-[var(--text-secondary)]">Fuel Type</p><p id="detail-fuel-type" class="font-semibold"></p></div>
                    <div><p class="font-medium text-[var(--text-secondary)]">Engine No.</p><p id="detail-engine-no" class="font-semibold"></p></div>
                    <div><p class="font-medium text-[var(--text-secondary)]">Chassis No.</p><p id="detail-chassis-no" class="font-semibold"></p></div>
                    <div class="col-span-2">
                        <p class="font-medium text-[var(--text-secondary)]">Client Name</p>
                        <div id="client-name-wrapper">
                             <p id="detail-client-name" class="font-semibold"></p>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <p class="font-medium text-[var(--text-secondary)]">Client Phone</p>
                        <div id="client-phone-wrapper">
                            <p id="detail-client-phone" class="font-semibold"></p>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <div class="flex items-center justify-between mb-1">
                            <p class="font-medium text-[var(--text-secondary)]">Odometer Reading</p>
                            <span id="odometer-warning" class="text-xs text-red-600 font-medium italic hidden"></span>
                        </div>
                        <div id="odometer-display-wrapper">
                            <p id="detail-odometer" class="font-semibold"></p>
                        </div>
                    </div>
                </div></div>
                
                <div id="create-vehicle-section" class="card hidden space-y-4">
                    <h2 class="text-xl font-bold flex items-center gap-2 text-orange-600"><span class="material-symbols-outlined">add_circle</span> Register New Vehicle</h2>
                    <p class="text-sm text-gray-500 -mt-2">Vehicle not found. Please add the details below to register it.</p>
                    <form id="create-vehicle-form" onsubmit="event.preventDefault(); createVehicle();" class="border-t pt-4"><div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div><label class="form-label">Vehicle Number</label><input id="new-vehicle-number" type="text" class="form-input bg-gray-100" readonly></div>
                    <div><label class="form-label">Vehicle Name</label><input id="new-vehicle-name" type="text" class="form-input" placeholder="e.g., Swift VXI" ></div>
                    <div><label class="form-label">Brand</label><select id="new-vehicle-brand-exec" class="form-input" required onchange="populateModelDropdown()"></select></div>
                    <div><label class="form-label">Model</label><select id="new-vehicle-model-exec" class="form-input" required></select></div>
                    <div><label class="form-label">Color</label><input id="new-color" type="text" class="form-input" placeholder="e.g., White" ></div>
                    <div><label class="form-label">Fuel Type</label><select id="new-fuel-type" class="form-input" required><option value="">Select Type</option><option>Petrol</option><option>Diesel</option><option>CNG</option><option>Electric</option></select></div>
                    <div><label class="form-label">Engine Number</label><input id="new-engine-no" type="text" class="form-input" placeholder="Enter engine number" required></div>
                    <div><label class="form-label">Chassis Number</label><input id="new-chassis-no" type="text" class="form-input" placeholder="Enter chassis number" required></div>
                    <div class="sm:col-span-2"><label class="form-label">Odometer Reading (km)</label><input id="new-odometer" type="number" class="form-input" placeholder="e.g., 54000" required></div>
                    <div class="sm:col-span-2 border-t pt-4"><label class="form-label">Client Name</label><input id="new-client-name" type="text" class="form-input" placeholder="e.g., John Doe" required></div>
<div class="sm:col-span-2">
    <label class="form-label">Client Phone</label>
    <input id="new-client-phone" type="tel" class="form-input" placeholder="e.g., 9876543210" required maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
</div>
                </div><div class="mt-6"><button type="submit" class="btn-primary"><span class="material-symbols-outlined">save</span>Save Vehicle</button></div></form></div>
                
                <div id="new-complaint-section" class="card hidden">
                    <h2 class="text-xl font-bold mb-4">Register New Complaint(s)</h2>
                    <div class="border-t pt-4 space-y-4">
                        <div id="complaints-list" class="space-y-2">
                            <p class="text-sm text-gray-500">No complaints added yet.</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="complaint-input" type="text" class="form-input flex-grow" placeholder="e.g., Engine noise on startup" onkeydown="if(event.key==='Enter'){event.preventDefault(); addComplaint();}">
                            <button type="button" onclick="addComplaint()" class="p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 shrink-0">
                                <span class="material-symbols-outlined">add</span>
                            </button>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t">
                          <label class="form-label">Mark Damages on Vehicle</label>
                          <div class="relative inline-block border border-gray-300 rounded-lg overflow-hidden">
							<img src="https://thumbs.dreamstime.com/b/car-line-art-ilustration-vector-car-line-art-ilustration-vector-car-line-art-ilustration-vector-118291586.jpg?w=768" id="carImage" alt="Car Outline" class="block w-full max-w-sm bg-white" crossorigin="anonymous"/>
							<canvas id="damageCanvas" class="absolute top-0 left-0"></canvas>
							<canvas id="checkCanvas" class="hidden"></canvas>
						  </div>
                          <p class="text-sm text-gray-500 mt-2">Click on the car image to mark scratches/damages.</p>
                          <div class="flex items-center gap-3 mt-3">
                              <button type="button" onclick="undoLastMark()" class="btn-secondary !py-2 !px-3 text-sm !w-auto flex items-center gap-1">
                                  <span class="material-symbols-outlined text-base">undo</span>Undo Last
                              </button>
                              <button type="button" onclick="clearDamageCanvas()" class="flex items-center gap-1 !w-auto rounded-lg bg-red-100 text-red-700 font-bold py-2 px-3 shadow-sm hover:bg-red-200 transition-colors text-sm">
                                  <span class="material-symbols-outlined text-base">delete_sweep</span>Clear All
                              </button>
                          </div>
                          </div>
                        
                        <div class="mt-4 pt-4 border-t space-y-3">
                            <label class="form-label">Attach Photos & Voice Note</label>
                            <!-- Photo Upload -->
                            <div>
                                <input type="file" id="photo-upload-input" multiple accept="image/*" class="hidden" onchange="handlePhotoUploads(event)">
                                <button type="button" onclick="document.getElementById('photo-upload-input').click()" class="btn-secondary !w-auto !py-2 !px-3 text-sm flex items-center gap-2">
                                    <span class="material-symbols-outlined">add_a_photo</span> Add Photos
                                </button>
                                <div id="photo-previews" class="mt-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3"></div>
                            </div>
                            <!-- Voice Note -->
                            <div>
                                <div class="flex items-center gap-3">
                                    <button id="record-btn" type="button" onclick="startRecording()" class="btn-secondary !w-auto !py-2 !px-3 text-sm flex items-center gap-2">
                                        <span class="material-symbols-outlined">mic</span> Record Note
                                    </button>
                                    <button id="stop-record-btn" type="button" onclick="stopRecording()" class="btn-primary !w-auto !py-2 !px-3 text-sm flex items-center gap-2 hidden !bg-red-600">
                                        <span class="material-symbols-outlined">stop_circle</span> Stop
                                    </button>
                                </div>
                                <div id="audio-playback" class="mt-3"></div>
                                 <p id="recording-status" class="text-sm text-gray-500 mt-1"></p>
                            </div>
                        </div>

                        <div class="mt-6">
                            <button onclick="saveComplaints()" class="btn-primary"><span class="material-symbols-outlined">add_task</span>Save Complaints & Media</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="vehicle-update-screen" class="executive-screen" style="display: none;">
             <main class="app-main">
                <div class="card relative"><h2 class="text-xl font-bold mb-4">Search Report to Update</h2><input id="update-search-input" onkeyup="handleReportUpdateSearch()" type="text" placeholder="Start typing vehicle number..." class="form-input"><div id="prediction-list" class="absolute top-full left-5 right-5 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 hidden"></div></div>
                <div id="update-details-section" class="card hidden space-y-4">
                    <h2 class="text-xl font-bold flex items-center gap-2 text-green-600"><span class="material-symbols-outlined">check_circle</span> Selected Report</h2>
                    <div class="grid grid-cols-2 gap-4 text-base border-t pt-4">
                        <div><p class="font-medium text-[var(--text-secondary)]">Vehicle Number</p><p id="update-detail-number" class="font-bold text-lg"></p></div>
                        <div><p class="font-medium text-[var(--text-secondary)]">Total Complaints</p><p id="update-detail-complaint" class="font-semibold"></p></div>
                    </div>
                </div>
                <div id="update-form-section" class="card hidden">
                    <form onsubmit="event.preventDefault(); saveVehicleUpdate(true);" class="space-y-6">
                        <div><label class="form-label">Suggested Repair (from Executive)</label><div class="flex items-center gap-2"><input id="suggestion-input" type="text" class="form-input flex-grow" placeholder="e.g., Change engine oil"><button type="button" onclick="addSuggestion()" class="p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200"><span class="material-symbols-outlined">add</span></button></div><div id="executive-suggestions-list" class="mt-3 space-y-2"></div></div>
                        <div><h3 class="text-base font-bold mb-2 border-t pt-4">Customer Approved Suggestions</h3><div id="customer-approval-list" class="space-y-2"><p class="text-sm text-gray-500">Add suggestions above to see them here for approval.</p></div></div>
                        
                        <div>
                            <h3 class="text-base font-bold mb-2 border-t pt-4">Materials Required for Service</h3>
                            <div class="flex items-center gap-2">
                                <input id="material-input" type="text" class="form-input flex-grow" placeholder="e.g., Engine Oil 5L">
                                <button type="button" onclick="addMaterial()" class="p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200">
                                    <span class="material-symbols-outlined">add</span>
                                </button>
                            </div>
                            <div id="materials-list" class="mt-3 space-y-2">
                                <p class="text-sm text-gray-500">No materials added yet.</p>
                            </div>
                        </div>

                        <div><label for="delivery-date" class="form-label border-t pt-4">Expected Delivery Date</label><input id="delivery-date" type="date" class="form-input"></div>
                        
                        <div class="pt-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button type="submit" class="btn-secondary">
                                <span class="material-symbols-outlined">save</span>Save Selections
                            </button>
                            <button type="button" onclick="sendApprovalLink()" class="btn-whatsapp">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.001 2.269.655 4.505 1.905 6.344l-1.225 4.485 4.635-1.218z"/>
                                </svg>
                                <span>Send Approval Link</span>
                            </button>
                        </div>
                    </form>
                </div>
             </main>
        </div>
        
        <div id="report-screen" class="executive-screen" style="display: none;">
            <main class="app-main">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Filter Reports</h2>
                    <div id="report-filters" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 items-end">
                        <div class="space-y-1">
    <label for="filter-from-date" class="text-xs font-medium text-gray-500">From Date</label>
    <input type="date" id="filter-from-date" class="form-input" onchange="handleDateChange('filter-from-date', 'filter-to-date'); applyReportFilters();">
</div>
<div class="space-y-1">
    <label for="filter-to-date" class="text-xs font-medium text-gray-500">To Date</label>
    <input type="date" id="filter-to-date" class="form-input" onchange="handleDateChange('filter-from-date', 'filter-to-date'); applyReportFilters();">
</div>
                       
                        <input type="text" id="filter-vehicle-no" class="form-input" placeholder="Vehicle Number" oninput="applyReportFilters()">
                        <input type="text" id="filter-brand" class="form-input" placeholder="Brand" oninput="applyReportFilters()">
                        <input type="text" id="filter-exec-name" class="form-input" placeholder="Executive Name" oninput="applyReportFilters()">
                        <button onclick="clearReportFilters()" class="text-sm h-11 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300">Clear Filters</button>
                    </div>
                </div>
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold">Service History</h2>
    <button onclick="downloadReport()" class="flex items-center gap-1 px-3 py-1 text-sm font-bold text-white bg-green-600 rounded-lg hover:bg-green-700">
        <span class="material-symbols-outlined">download</span>
        Download Report
    </button>
</div>
                    <div class="table-container">
                        <table class="report-table">
                           <thead>
                                <tr>
                                    <th>Vehicle No.</th>
                                    <th>Vehicle Name</th>
                                    <th>Model</th>
                                    <th>Brand</th>
                                    <th>Color</th>
                                    <th>Engine No</th>
                                    <th>Chassis No</th>
                                    <th>Client Name</th>
                                    <th>Client Phone</th>
                                    <th>Odometer</th>
                                    <th>Executive</th>
                                    <th>Date & Time</th>
                                    <th>Status</th>
                                    <th>Complaint</th>
                                    <th>Suggested</th>
                                    <th>Approved</th>
                                    <th>Materials Required</th>
                                    <th>Marks</th>
                                    <th>Executive Media</th>
                                    <th>Customer Feedback</th>
                                    <th>Customer Voice Note</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body"></tbody>
                        </table>
                    </div>
                    <p id="no-reports-message" class="text-center text-gray-500 py-8 hidden">No reports found matching your criteria.</p>
                </div>
            </main>
        </div>
        <div id="due-date-screen" class="executive-screen" style="display: none;">
            <main class="app-main">
                <div id="due-date-list" class="space-y-1">
                    </div>
                <p id="no-due-dates-message" class="text-center text-gray-500 py-8 hidden">No upcoming due dates found.</p>
            </main>
        </div>
        <div id="profile-screen" class="executive-screen" style="display: none;">
            <main class="app-main">
                <div class="card">
                    <div class="flex flex-col items-center">
                        <div class="w-24 h-24 rounded-full bg-blue-100 flex items-center justify-center mb-4"><span class="material-symbols-outlined text-6xl text-blue-600">person</span></div>
                        <h2 id="profile-username" class="text-2xl font-bold"></h2>
                        <p id="profile-role" class="text-[var(--text-secondary)] capitalize"></p>
                    </div>
                </div>
                 <div class="card">
                    <h2 class="text-xl font-bold mb-4">Google Drive Integration</h2>
                    <div id="gdrive-auth-section" class="w-full text-center border-t pt-4">
                        <p class="text-sm text-gray-600 mb-2">Manage access for media uploads.</p>
                        <button id="auth-button" onclick="handleAuthClick()" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2 w-full">
                            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                            Authorize Google Drive
                        </button>
                        <button id="signout-button" onclick="handleSignoutClick()" class="hidden bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg w-full mt-2">
                            Sign Out of Google Drive
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Reset Password</h2>
                    <form onsubmit="event.preventDefault(); resetPassword();" class="space-y-4 border-t pt-4">
                        <div><label class="form-label">Current Password</label><input id="current-password" type="password" class="form-input" required></div>
                        <div><label class="form-label">New Password</label><input id="new-password" type="password" class="form-input" required></div>
                        <div><label class="form-label">Confirm New Password</label><input id="confirm-new-password" type="password" class="form-input" required></div>
                        <div class="pt-2"><button type="submit" class="btn-primary"><span class="material-symbols-outlined">lock_reset</span>Reset Password</button></div>
                    </form>
                </div>
                 <div class="card">
                    <button onclick="logout()" class="w-full flex justify-center items-center gap-2 text-red-600 font-bold py-3 px-4 rounded-lg hover:bg-red-50"><span class="material-symbols-outlined">logout</span>Logout</button>
                 </div>
            </main>
        </div>

        <footer class="bottom-nav">
             <div class="max-w-5xl mx-auto flex justify-around">
                <a href="javascript:void(0)" class="nav-item active" data-target="job-card-screen" onclick="showExecutiveScreen('job-card-screen')"><span class="material-symbols-outlined">description</span><span>Job Card</span></a>
                <a href="javascript:void(0)" class="nav-item" data-target="vehicle-update-screen" onclick="showExecutiveScreen('vehicle-update-screen')"><span class="material-symbols-outlined">update</span><span>Update</span></a>
                <a href="javascript:void(0)" class="nav-item" data-target="report-screen" onclick="showExecutiveScreen('report-screen')"><span class="material-symbols-outlined">assessment</span><span>Report</span></a>
                <a href="javascript:void(0)" class="nav-item" data-target="due-date-screen" onclick="showExecutiveScreen('due-date-screen')"><span class="material-symbols-outlined">event_available</span><span>Due Date</span></a>
                <a href="javascript:void(0)" class="nav-item" data-target="profile-screen" onclick="showExecutiveScreen('profile-screen')"><span class="material-symbols-outlined">person</span><span>Profile</span></a>
            </div>
        </footer>
    </div>
    
    <!-- This is the new screen for customer approvals -->
    <div id="customer-approval-screen" class="screen">
        <header class="app-header">
            <div class="app-header-content">
                 <h1 class="text-2xl font-bold text-[var(--primary-color)] flex-1 text-center flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">minor_crash</span> AutoFix Service Approval
                </h1>
            </div>
        </header>
        <main id="customer-approval-main" class="app-main max-w-2xl mx-auto">
            <div id="customer-loading" class="text-center py-10">
                <p class="flex items-center justify-center gap-2 text-lg text-gray-600">
                    <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Loading your service details...
                </p>
            </div>
            <div id="customer-approval-content" class="hidden space-y-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-3">Vehicle Details</h2>
                    <div class="grid grid-cols-2 gap-4 border-t pt-3">
                        <div><p class="text-sm text-gray-500">Vehicle Number</p><p id="cust-vehicle-no" class="font-bold"></p></div>
                        <div><p class="text-sm text-gray-500">Vehicle Name</p><p id="cust-vehicle-name" class="font-bold"></p></div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-bold mb-3">Please Approve Repairs</h2>
                    <p class="text-sm text-gray-500 -mt-2 mb-4">Select the services you would like to approve from the list below.</p>
                    <div id="cust-approval-list" class="space-y-3 border-t pt-4">
                        <!-- Items will be injected here by JS -->
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-bold mb-3">Additional Comments or Suggestions</h2>
                     <textarea id="customer-feedback-text" class="form-input" rows="4" placeholder="If you have any other concerns or requests, please write them here..."></textarea>
                </div>
                <div class="card">
                    <h2 class="text-xl font-bold mb-3">Record a Voice Note</h2>
                    <p class="text-sm text-gray-500 -mt-2 mb-4">If it's easier, you can record a voice message for our team.</p>
                    <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                        <button id="cust-record-btn" onclick="toggleRecording()" class="flex items-center justify-center gap-2 w-full rounded-lg bg-red-600 text-white font-bold py-3 px-4 shadow-sm hover:bg-red-700 transition-colors">
                            <span class="material-symbols-outlined">mic</span>
                            <span id="cust-record-btn-text">Start Recording</span>
                        </button>
                        <audio id="cust-audio-playback" controls class="hidden w-full"></audio>
                    </div>
                     <p id="cust-recording-status" class="text-xs text-center mt-2 text-gray-500"></p>
                </div>
                <div id="customer-submit-section">
                    <button onclick="submitCustomerApproval()" class="btn-primary">
                        <span class="material-symbols-outlined">task_alt</span>
                        Submit Approval
                    </button>
                </div>
            </div>
             <div id="customer-thank-you" class="hidden card text-center py-10">
                <span class="material-symbols-outlined text-6xl text-green-500">check_circle</span>
                <h2 class="text-2xl font-bold mt-4">Thank You!</h2>
                <p class="text-gray-600 mt-1">Your approval has been submitted. Our team will get in touch with you shortly.</p>
            </div>
        </main>
    </div>


    <div id="success-message" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-lg hidden flex items-center gap-2 transition-transform duration-300 transform"><span class="material-symbols-outlined">check_circle</span><span id="success-text"></span></div>
    <div id="error-message" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-lg hidden flex items-center gap-2 transition-transform duration-300 transform"><span class="material-symbols-outlined">error</span><span id="error-text"></span></div>
    
    <div id="scanner-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" onclick="closeScannerModal()"></div>
        <div class="relative bg-white rounded-lg p-4 w-full max-w-lg m-4 space-y-4">
            <div class="flex justify-between items-center pb-2 border-b">
                <h3 class="text-xl font-bold text-gray-800">Analyze Number Plate</h3>
                <button onclick="closeScannerModal()" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-800">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="image-preview-container" class="bg-gray-200 rounded-lg overflow-hidden aspect-video relative flex items-center justify-center">
                 <img id="scanner-image-preview" class="max-w-full max-h-full object-contain">
            </div>
            <p id="scanner-status" class="text-center text-gray-600 min-h-[1.5rem] flex items-center justify-center gap-2"></p>
            <button id="analyze-btn" onclick="analyzeImageWithAPI()" class="btn-primary">
                <span class="material-symbols-outlined">visibility</span>Analyze Image
            </button>
        </div>
    </div>


    <div id="delete-confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-hidden"><div class="fixed inset-0 bg-black/60 backdrop-blur-sm"></div><div class="relative bg-white rounded-lg p-6 w-full max-w-sm m-4 space-y-4"><h3 class="text-xl font-bold text-gray-800">Confirm Deletion</h3><p id="delete-modal-text" class="text-gray-600"></p><div class="flex justify-end gap-4 pt-4"><button onclick="hideModal('delete-confirmation-modal')" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold">Cancel</button><button id="confirm-delete-button" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">Confirm Delete</button></div></div></div>

    <div id="marks-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 modal-hidden z-50">
      <div class="bg-white rounded-lg p-4 relative max-w-lg w-full">
        <button onclick="closeMarksModal()" class="absolute -top-2 -right-2 text-white bg-red-600 rounded-full h-8 w-8 flex items-center justify-center font-bold">&times;</button>
        <h2 class="text-lg font-bold mb-2">Damage Marks</h2>
        <div class="relative inline-block">
  <img src="https://thumbs.dreamstime.com/b/car-line-art-ilustration-vector-car-line-art-ilustration-vector-car-line-art-ilustration-vector-118291586.jpg?w=768"
       id="modalCarImage" alt="Car Outline with Marks" class="block w-full max-w-sm bg-white" crossorigin="anonymous"/>
  <canvas id="modalCanvas" class="absolute top-0 left-0"></canvas>
</div>
      </div>
    </div>
    
	<div id="printable-job-card" class="printable-area">
    <style>
        /* Specific styles for the print layout */
        .print-body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #fff;
            color: #000;
        }
        .print-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .print-header h1 {
            margin: 0;
            font-size: 28px;
        }
        .print-header p {
            margin: 5px 0 0;
            font-size: 14px;
        }
        .print-section {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .print-section-title {
            font-size: 18px;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .print-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .print-grid .details p, .print-details-list p {
            margin: 0 0 8px;
            font-size: 14px;
        }
        .print-grid .details strong, .print-details-list strong {
            display: block;
            font-size: 12px;
            color: #555;
            margin-bottom: 2px;
        }
        .print-details-list ul {
            list-style-type: disc;
            margin: 0;
            padding-left: 20px;
        }
        .print-damage-section {
            text-align: center;
        }
        .print-damage-section .image-container {
            position: relative;
            display: inline-block;
            border: 1px solid #ccc;
            padding: 5px;
        }
        .print-damage-section img {
            display: block;
            max-width: 400px;
            background-color: #fff;
        }
        .print-damage-section canvas {
            position: absolute;
            top: 5px;
            left: 5px;
        }
        .print-footer {
            margin-top: 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 100px;
            font-size: 14px;
        }
        .print-footer div {
            border-top: 1px solid #000;
            padding-top: 10px;
            text-align: center;
        }
    </style>
    <div class="print-body">
        <div class="print-header">
            <h1>AutoFix Service</h1>
            <p>Job Card / Service Report</p>
        </div>
        
        <div class="print-section">
            <h2 class="print-section-title">Report & Vehicle Details</h2>
            <div class="print-grid">
                <div class="details">
                    <p><strong>Report Date:</strong> <span id="print-report-date"></span></p>
                    <p><strong>Client Name:</strong> <span id="print-client-name"></span></p>
                    <p><strong>Client Phone:</strong> <span id="print-client-phone"></span></p>
                    <p><strong>Service Executive:</strong> <span id="print-executive-name"></span></p>
                </div>
                <div class="details">
                    <p><strong>Vehicle No:</strong> <span id="print-vehicle-no"></span></p>
                    <p><strong>Vehicle Name:</strong> <span id="print-vehicle-name"></span></p>
                    <p><strong>Engine/Chassis No:</strong> <span id="print-engine-chassis"></span></p>
                    <p><strong>Odometer:</strong> <span id="print-odometer"></span> km</p>
                </div>
            </div>
        </div>

        <div class="print-section print-details-list">
            <h2 class="print-section-title">Service Details</h2>
            <p><strong>Customer Complaints:</strong></p>
            <ul id="print-complaints-list"></ul>
            <br>
            <p><strong>Suggested Repairs:</strong></p>
            <ul id="print-suggested-list"></ul>
            <br>
            <p><strong>Approved Repairs:</strong></p>
            <ul id="print-approved-list"></ul>
            <br>
            <p><strong>Materials Required:</strong></p>
            <ul id="print-materials-list"></ul>
        </div>

        <div class="print-section print-damage-section">
            <h2 class="print-section-title">Vehicle Damage Marks</h2>
            <div class="image-container">
                <img id="print-car-image" src="https://thumbs.dreamstime.com/b/car-line-art-ilustration-vector-car-line-art-ilustration-vector-car-line-art-ilustration-vector-118291586.jpg?w=768" crossorigin="anonymous" />
                <canvas id="print-damage-canvas"></canvas>
            </div>
        </div>

        <div class="print-footer">
            <div><strong>Executive Signature</strong></div>
            <div><strong>Customer Signature</strong></div>
        </div>
    </div>
</div>
    
    <script>
        // --- Google API Client Libraries ---
        // Moved to bottom of body to ensure functions are defined before they are called.
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (resp) => { // Centralized callback
                    if (resp.error !== undefined) {
                        showError('Authorization failed. Please try again.');
                        throw (resp);
                    }
                    updateAuthUI(true);
                    showSuccessMessage('Google Drive access authorized.');
                },
            });
            gisInited = true;
            checkInitialAuth();
        }
    </script>
    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://gfylsjfljnwyomfouwvs.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmeWxzamZsam53eW9tZm91d3ZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MDc5MTYsImV4cCI6MjA3Mjk4MzkxNn0.hMvLvCDVaFtq0rXToHGOJPSFe-QnJ6_S-MYsI0d5zOs';
        const sb = createClient(supabaseUrl, supabaseKey);

        // --- Google Drive API Configuration ---
        const CLIENT_ID = '903962440902-olb0km18p980o04na5hi4ah4f6lanms1.apps.googleusercontent.com'; // Paste your OAuth 2.0 Client ID here
        const API_KEY = 'AIzaSyDq39bo-QQRWbPWM0qWcolswBdkBpiLR3w'; // Paste your API Key here
        const PARENT_FOLDER_ID = '1jmD_XBl_4a_FEvT3xQ9RKgH7-26gmM30'; // Paste your Google Drive Folder ID here

        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // --- Global State ---
        let currentUser = null;
        let vehicleModelsCache = [];
        let reportsDataStore = {};
        let currentVehicleId = null;
        let currentReportId = null;
        let originalComplaintsForUpdate = [];
		let newSuggestions = [];
        let currentComplaints = []; 
        let currentOdometer = 0; 
        let originalClientName = '';
        let originalClientPhone = '';
        let damageMarks = [];
        let uploadedImageFile = null;
        let capturedPhotos = [];
        let voiceNoteBlob = null;
        let mediaRecorder;
        let audioChunks = [];
        let currentMaterials = [];
        let recordedAudioBlob = null;
        
        // --- UI Element References ---
        const vehicleDetailsSection = document.getElementById('vehicle-details-section');
        const createVehicleSection = document.getElementById('create-vehicle-section');
        const newComplaintSection = document.getElementById('new-complaint-section');
        const searchError = document.getElementById('search-error');
        const predictionList = document.getElementById('prediction-list');
        const updateDetailsSection = document.getElementById('update-details-section');
        const updateFormSection = document.getElementById('update-form-section');

        // --- Canvas-related variables ---
        let carImage, damageCanvas, checkCanvas, damageCtx, checkCtx;
        
        // --- Global Error Handler ---
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled Promise Rejection:', event.reason);
            let errorMessage = 'An unexpected error occurred. Please try again.';
            if (event.reason instanceof Error) {
                if (event.reason.message.toLowerCase().includes('failed to fetch') || event.reason.message.toLowerCase().includes('network')) {
                     errorMessage = 'Network error. Please check your connection.';
                } else {
                    errorMessage = event.reason.message;
                }
            }
            showError(errorMessage);
            event.preventDefault();
        });

        // --- OCR & Media Functions ---
        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1280;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: Date.now() }));
                            } else {
                                reject(new Error('Canvas to Blob conversion failed'));
                            }
                        }, 'image/jpeg', 0.85);
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        async function callOcrSpaceAPI(imageFile) {
            const statusEl = document.getElementById('scanner-status');
            statusEl.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>Analyzing with OCR...</span>`;
            const formData = new FormData();
            formData.append('file', imageFile);
            formData.append('apikey', 'helloworld');
            formData.append('language', 'eng');
            formData.append('ocrengine', 2);
            const response = await fetch('https://api.ocr.space/parse/image', {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            if (result.IsErroredOnProcessing) throw new Error(result.ErrorMessage.join(' '));
            if (result.ParsedResults && result.ParsedResults.length > 0) {
                 return result.ParsedResults[0].ParsedText;
            } else {
                return '';
            }
        }
        function findBestMatchForPlate(text) {
            if (!text) return null;
            const cleanedText = text.replace(/[\s\n\r\t.,!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/g, '').toUpperCase();
            const patterns = [
                /\d{2}BH\d{4}[A-Z]{2}/,
                /[A-Z]{2}\d{1,2}[A-Z]{1,2}\d{4}/,
                /[A-Z]{2}\d{2}[A-Z]{1,2}\d{3}/,
                /[A-Z]{2}\d{2}[A-Z]{1,2}\d{1,4}/,
            ];
            for (const pattern of patterns) {
                const match = cleanedText.match(pattern);
                if (match) return match[0];
            }
            return null;
        }
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showModal('scanner-modal');
            const statusEl = document.getElementById('scanner-status');
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.disabled = true;
            statusEl.innerHTML = `
                <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>Processing image...</span>`;
            try {
                const resizedFile = await resizeImage(file);
                uploadedImageFile = resizedFile;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('scanner-image-preview').src = e.target.result;
                    statusEl.textContent = 'Image loaded. Click below to analyze.';
                    analyzeBtn.disabled = false;
                };
                reader.readAsDataURL(resizedFile);
            } catch (error) {
                console.error("Image processing error:", error);
                showError("Could not process the selected image.");
                closeScannerModal();
            }
            event.target.value = '';
        }
        function closeScannerModal() {
            document.getElementById('scanner-image-preview').src = '';
            uploadedImageFile = null;
            hideModal('scanner-modal');
        }
        async function analyzeImageWithAPI() {
            if (!uploadedImageFile) {
                showError("No image selected to process.");
                return;
            }
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.disabled = true;
            try {
                const textFromAPI = await callOcrSpaceAPI(uploadedImageFile);
                const bestMatch = findBestMatchForPlate(textFromAPI);
                if (bestMatch) {
                    const finalNumber = normalizeVehicleNumber(bestMatch);
                    document.getElementById('search-vehicle-number').value = finalNumber;
                    showSuccessMessage(`Detected: ${finalNumber}`);
                    closeScannerModal();
                    searchVehicle();
                } else {
                    showError('Could not find a valid number plate in the image.');
                    document.getElementById('scanner-status').textContent = 'No number plate found. Try a clearer shot.';
                    analyzeBtn.disabled = false;
                }
            } catch (error) {
                console.error("API Error:", error);
                showError("An error occurred during analysis: " + error.message);
                document.getElementById('scanner-status').textContent = 'An error occurred. Please try again.';
                analyzeBtn.disabled = false;
            }
        }
        function handlePhotoUploads(event) {
            const files = event.target.files;
            if (!files) return;
            const previewsContainer = document.getElementById('photo-previews');
            previewsContainer.innerHTML = '';
            capturedPhotos = Array.from(files);
            for (const file of capturedPhotos) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewWrapper = document.createElement('div');
                    previewWrapper.className = 'relative aspect-square';
                    previewWrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`;
                    previewsContainer.appendChild(previewWrapper);
                };
                reader.readAsDataURL(file);
            }
        }
        async function startRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('Audio recording is not supported on this browser.');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });
                mediaRecorder.addEventListener("stop", () => {
                    voiceNoteBlob = new Blob(audioChunks, { 'type' : 'audio/webm' });
                    const audioUrl = URL.createObjectURL(voiceNoteBlob);
                    document.getElementById('audio-playback').innerHTML = `<audio controls src="${audioUrl}" class="w-full"></audio>`;
                });
                mediaRecorder.start();
                document.getElementById('record-btn').classList.add('hidden');
                document.getElementById('stop-record-btn').classList.remove('hidden');
                document.getElementById('recording-status').textContent = 'Recording...';
            } catch (err) {
                showError('Microphone access was denied.');
                console.error("Mic Error:", err);
            }
        }
        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                document.getElementById('record-btn').classList.remove('hidden');
                document.getElementById('stop-record-btn').classList.add('hidden');
                document.getElementById('recording-status').textContent = 'Recording stopped. Press Save to upload.';
            }
        }

        // --- AUTH & CORE ---
        const normalizeVehicleNumber = (num) => {
            if (!num) return '';
            return num.toUpperCase();
        };
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!username || !password) return showError('Username and password are required.');
            const { data, error } = await sb.from('users').select('*').ilike('username', username).single();
            if (error || !data || data.password.toLowerCase() !== password.toLowerCase()) return showError('Invalid credentials.');
            currentUser = data;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); 
            if (currentUser.role === 'admin') {
                showAdminScreen('admin-dashboard-screen');
            } else if (currentUser.role === 'executive') {
                document.getElementById('profile-username').textContent = currentUser.username;
                document.getElementById('profile-role').textContent = currentUser.role;
                showExecutiveScreen('job-card-screen');
                setTimeout(checkInitialAuth, 1000);
            } else return showError('Unknown user role.');
            showSuccessMessage(`Welcome, ${currentUser.username}!`);
        }
        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            handleSignoutClick();
            showScreen('login-screen');
            resetVehicleUpdateScreen();
            resetJobCardState();
        }
        function handleDateChange(fromId, toId) {
            const fromDateInput = document.getElementById(fromId);
            const toDateInput = document.getElementById(toId);
            if (fromDateInput.value) toDateInput.min = fromDateInput.value;
            if (toDateInput.value) fromDateInput.max = toDateInput.value;
        }

        // --- ADMIN & MANAGEMENT ---
        async function renderVehicleModelList() {
            const { data, error } = await sb.from('vehicle_models').select('*').order('brand');
            if (error) return showError('Could not fetch vehicle models.');
            vehicleModelsCache = data; 
            const list = document.getElementById('vehicle-models-list');
            list.innerHTML = '';
            if (data.length === 0) { list.innerHTML = `<p class="text-sm text-gray-500">No vehicle models created yet.</p>`; return; }
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `<p class="font-semibold">${item.brand} - ${item.model}</p><button onclick="confirmDeletion('vehicle_model', ${item.id})" class="text-red-500 hover:text-red-700"><span class="material-symbols-outlined">delete</span></button>`;
                list.appendChild(div);
            });
        }
        async function addVehicleModel() {
            const brand = document.getElementById('new-brand-admin').value.trim();
            const model = document.getElementById('new-model-admin').value.trim();
            if (!brand || !model) return showError('Brand and model are required.');
            const { error } = await sb.from('vehicle_models').insert({ brand, model });
            if (error) return showError(`Could not add model: ${error.message}`);
            document.getElementById('add-vehicle-model-form').reset();
            showSuccessMessage("Vehicle model added.");
            renderVehicleModelList();
        }
        async function renderUserList(role) {
            const listId = role === 'admin' ? 'admins-list' : 'executives-list';
            const list = document.getElementById(listId);
            list.innerHTML = '';
            const { data, error } = await sb.from('users').select('id, username').eq('role', role);
            if(error) return showError(`Could not fetch ${role}s.`);
            data.forEach(user => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `<p class="font-semibold">${user.username}</p><button onclick="confirmDeletion('user', ${user.id}, '${role}')" class="text-red-500 hover:text-red-700"><span class="material-symbols-outlined">delete</span></button>`;
                list.appendChild(div);
            });
        }
        async function addUser(role) {
            const usernameInputId = role === 'admin' ? 'new-admin-username' : 'new-exec-username';
            const passwordInputId = role === 'admin' ? 'new-admin-pass' : 'new-exec-pass';
            const formId = role === 'admin' ? 'add-admin-form' : 'add-exec-form';
            const username = document.getElementById(usernameInputId).value.trim();
            const password = document.getElementById(passwordInputId).value.trim();
            if(!username || !password) return showError('Username and password are required.');
            const { error } = await sb.from('users').insert({ username, password, role });
            if(error) return showError(`Could not create ${role}: ${error.message}`);
            showSuccessMessage(`${role.charAt(0).toUpperCase() + role.slice(1)} created.`);
            document.getElementById(formId).reset();
            renderUserList(role);
        }

        // --- REPORTS & ANALYTICS ---
        async function fetchAndPopulateReports(isAdmin = false) {
            const tableBodyId = isAdmin ? 'admin-report-table-body' : 'report-table-body';
            const noReportsMsgId = isAdmin ? 'admin-no-reports-message' : 'no-reports-message';
            const tableBody = document.getElementById(tableBodyId);
            const noReportsMsg = document.getElementById(noReportsMsgId);
            const fromDate = document.getElementById(isAdmin ? 'admin-filter-from-date' : 'filter-from-date').value;
            const toDate = document.getElementById(isAdmin ? 'admin-filter-to-date' : 'filter-to-date').value;
            const vehicleNo = document.getElementById(isAdmin ? 'admin-filter-vehicle-no' : 'filter-vehicle-no').value.trim().toUpperCase();
            const brand = document.getElementById(isAdmin ? 'admin-filter-brand' : 'filter-brand').value.trim();
            const execName = document.getElementById(isAdmin ? 'admin-filter-exec-name' : 'filter-exec-name').value.trim();
            let vehicleIdFilter = null;
            const intersect = (arr1, arr2) => arr1.filter(id => new Set(arr2).has(id));
            if (vehicleNo) {
                const { data, error } = await sb.from('vehicles').select('id').ilike('vehicle_no', `%${vehicleNo}%`);
                vehicleIdFilter = data ? data.map(v => v.id) : [];
            }
            if (brand) {
                const { data: models } = await sb.from('vehicle_models').select('id').ilike('brand', `%${brand}%`);
                const modelIds = models && models.length > 0 ? models.map(m => m.id) : null;
                if (modelIds) {
                    const { data: vehicles } = await sb.from('vehicles').select('id').in('model_id', modelIds);
                    const brandVehicleIds = vehicles ? vehicles.map(v => v.id) : [];
                    if (vehicleIdFilter !== null) vehicleIdFilter = intersect(vehicleIdFilter, brandVehicleIds);
                    else vehicleIdFilter = brandVehicleIds;
                } else vehicleIdFilter = [];
            }
            let query = sb.from('reports').select(`*, vehicles!inner(*, vehicle_models!inner(brand, model)), users!inner(username)`).order('created_at', { ascending: false });
            if (vehicleIdFilter !== null) {
                if (vehicleIdFilter.length === 0) { tableBody.innerHTML = ''; noReportsMsg.classList.remove('hidden'); return; }
                query = query.in('vehicle_id', vehicleIdFilter);
            }
            if (execName) {
                const { data } = await sb.from('users').select('id').ilike('username', `%${execName}%`);
                const userIds = data ? data.map(u => u.id) : [];
                if (userIds.length > 0) query = query.in('executive_id', userIds);
                else { tableBody.innerHTML = ''; noReportsMsg.classList.remove('hidden'); return; }
            } else if (!isAdmin) query = query.eq('executive_id', currentUser.id);
            if (fromDate) query = query.gte('created_at', `${fromDate}T00:00:00`);
            if (toDate) query = query.lte('created_at', `${toDate}T23:59:59`);
            const { data, error } = await query;
            if (error) { console.error('Filter Error:', error); return showError('Failed to fetch filtered reports.'); }
            reportsDataStore = {};
            data.forEach(row => reportsDataStore[row.id] = row);
            tableBody.innerHTML = '';
            if (data.length === 0) { noReportsMsg.classList.remove('hidden'); return; }
            noReportsMsg.classList.add('hidden');
            const statusColors = { 'Completed': 'bg-green-100 text-green-800', 'Ongoing': 'bg-orange-100 text-orange-800', 'Not Started': 'bg-red-100 text-red-800' };
            data.forEach(row => {
                const tr = document.createElement('tr');
                let marksButton = 'N/A';
                if (row.marks && row.marks.length > 2) marksButton = `<button onclick='openMarksModal(${JSON.stringify(row.marks)})' class="px-2 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 text-xs">View</button>`;
                let mediaLink = '<span class="text-xs text-gray-500">Not Uploaded</span>';
                if (row.gdrive_folder_url) mediaLink = `<a href="${row.gdrive_folder_url}" target="_blank" class="px-2 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 text-xs font-semibold">View Files</a>`;
                let voiceNotePlayer = 'N/A';
                if(row.customer_feedback_audio) voiceNotePlayer = `<audio controls src="${row.customer_feedback_audio}" class="w-48 h-8"></audio>`;
                
                tr.innerHTML = `
                    <td class="flex items-center gap-x-2"><button onclick='printJobCardById(${row.id})' class="text-gray-500 hover:text-green-600 p-1 rounded-full shrink-0"><span class="material-symbols-outlined">download</span></button><span>${row.vehicles.vehicle_no}</span></td>
                    <td>${row.vehicles.vehicle_name || 'N/A'}</td>
                    <td>${row.vehicles.vehicle_models.model}</td>
                    <td>${row.vehicles.vehicle_models.brand}</td>
                    <td>${row.vehicles.color || 'N/A'}</td>
                    <td>${row.vehicles.engine_no || 'N/A'}</td>
                    <td>${row.vehicles.chassis_no || 'N/A'}</td>
                    <td>${row.client_name || 'N/A'}</td>
                    <td>${row.client_phone || 'N/A'}</td>
                    <td>${row.odometer_reading || 'N/A'}</td>
                    <td>${row.users.username}</td>
                    <td>${new Date(row.created_at).toLocaleString('en-GB')}</td>
                    <td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[row.status] || 'bg-gray-100 text-gray-800'}">${row.status}</span></td>
                    <td class="whitespace-normal max-w-xs truncate" title="${formatArrayCell(row.complaint)}">${formatArrayCell(row.complaint)}</td>
                    <td class="whitespace-normal max-w-xs truncate" title="${formatArrayCell(row.suggested)}">${formatArrayCell(row.suggested)}</td>
                    <td class="whitespace-normal max-w-xs truncate" title="${formatArrayCell(row.approved)}">${formatArrayCell(row.approved)}</td>
                    <td class="whitespace-normal max-w-xs truncate" title="${formatArrayCell(row.materials_required)}">${formatArrayCell(row.materials_required)}</td>
                    <td>${marksButton}</td>
                    <td>${mediaLink}</td>
                    <td class="whitespace-normal max-w-xs truncate" title="${row.customer_feedback_text || ''}">${row.customer_feedback_text || 'N/A'}</td>
                    <td>${voiceNotePlayer}</td>
                `;
                tableBody.appendChild(tr);
            });
        }
        function applyAdminReportFilters() { fetchAndPopulateReports(true); }
        function clearAdminReportFilters() { 
            document.getElementById('admin-report-filters').querySelectorAll('input, select').forEach(input => input.value = ''); 
            document.getElementById('admin-filter-to-date').min = '';
            document.getElementById('admin-filter-from-date').max = '';
            fetchAndPopulateReports(true); 
        }
        function applyReportFilters() { fetchAndPopulateReports(false); }
        function clearReportFilters() { 
            document.getElementById('report-filters').querySelectorAll('input, select').forEach(input => input.value = ''); 
            document.getElementById('filter-to-date').min = '';
            document.getElementById('filter-from-date').max = '';
            fetchAndPopulateReports(false); 
        }
        async function renderAnalytics() {
            const month = document.getElementById('analytics-month-filter').value;
            const executiveId = document.getElementById('analytics-exec-filter').value;
            const executiveName = document.getElementById('analytics-exec-filter').selectedOptions[0].text;
            let query = sb.from('reports').select('status');
            if(month) query = query.like('created_at', `${month}%`);
            if(executiveId) query = query.eq('executive_id', executiveId);
            const { data, error } = await query;
            if(error) return showError('Failed to get analytics data.');
            const completed = data.filter(r => r.status === 'Completed').length;
            const pending = data.length - completed;
            const total = data.length;
            const completedPercent = total > 0 ? (completed / total * 100).toFixed(1) : 0;
            const pendingPercent = total > 0 ? (pending / total * 100).toFixed(1) : 0;
            const chartDiv = document.getElementById('analytics-chart');
            chartDiv.innerHTML = `<div><div class="flex justify-between text-sm mb-1"><span class="font-medium text-green-600">Completed (${completed})</span><span>${completedPercent}%</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div class="bg-green-500 h-3 rounded-full" style="width: ${completedPercent}%"></div></div></div><div><div class="flex justify-between text-sm mb-1"><span class="font-medium text-orange-600">Pending/Ongoing (${pending})</span><span>${pendingPercent}%</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div class="bg-orange-500 h-3 rounded-full" style="width: ${pendingPercent}%"></div></div></div>`;
            document.getElementById('analytics-title').textContent = `${executiveId ? executiveName : 'Overall'} Status for ${month ? new Date(month + '-02').toLocaleString('default', { month: 'long', year: 'numeric' }) : 'All Time'}`;
        }
        async function populateAnalyticsFilters() {
            const { data: execs, error: execsError } = await sb.from('users').select('id, username').eq('role', 'executive');
            if(execsError) return showError('Could not load executives.');
            const execFilter = document.getElementById('analytics-exec-filter');
            execFilter.innerHTML = '<option value="">All Executives</option>';
            execs.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = e.username;
                execFilter.appendChild(opt);
            });
            const { data: reports, error: reportsError } = await sb.from('reports').select('created_at');
            if(reportsError) return showError('Could not load report dates.');
            const monthFilter = document.getElementById('analytics-month-filter');
            const months = [...new Set(reports.map(r => r.created_at.substring(0, 7)))];
            monthFilter.innerHTML = '<option value="">All Months</option>';
            months.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = new Date(m + '-02').toLocaleString('default', { month: 'long', year: 'numeric' });
                monthFilter.appendChild(opt);
            });
        }
        
        // --- JOB CARD & VEHICLE ---
        async function searchVehicle() {
            const rawVehicleNumber = document.getElementById('search-vehicle-number').value;
            const vehicleNumber = normalizeVehicleNumber(rawVehicleNumber);
            hideAllSections();
            if (!vehicleNumber) return showError('Please enter a vehicle number.');
            const { data, error } = await sb.from('vehicles').select(`*, vehicle_models ( brand, model )`).eq('vehicle_no', vehicleNumber).single();
            if (data) { 
                currentVehicleId = data.id;
                currentOdometer = data.odometer;
                originalClientName = data.client_name;
                originalClientPhone = data.client_phone;
                document.getElementById('detail-vehicle-number').textContent = data.vehicle_no;
                document.getElementById('detail-brand').textContent = data.vehicle_models.brand;
                document.getElementById('detail-model').textContent = data.vehicle_models.model;
                document.getElementById('detail-fuel-type').textContent = data.fuel_type;
                document.getElementById('detail-vehicle-name').textContent = data.vehicle_name || 'N/A';
                document.getElementById('detail-color').textContent = data.color || 'N/A';
                document.getElementById('detail-engine-no').textContent = data.engine_no || 'N/A';
                document.getElementById('detail-chassis-no').textContent = data.chassis_no || 'N/A';
                document.getElementById('client-name-wrapper').innerHTML = `<input type="text" id="detail-client-name-input" class="form-input" value="${data.client_name || ''}">`;
                document.getElementById('client-phone-wrapper').innerHTML = `<input type="tel" id="detail-client-phone-input" class="form-input" value="${data.client_phone || ''}" maxlength="10" oninput="this.value = this.value.replace(/[^0-9]/g, '');">`;
                document.getElementById('odometer-display-wrapper').innerHTML = `<input type="number" id="detail-odometer-input" class="form-input" value="${data.odometer || 0}">`;
                document.getElementById('detail-odometer-input').addEventListener('blur', checkOdometer);
                vehicleDetailsSection.classList.remove('hidden');
                newComplaintSection.classList.remove('hidden');
                setTimeout(resizeCanvas, 50);
            } else { 
                currentVehicleId = null;
                currentOdometer = 0;
                document.getElementById('client-name-wrapper').innerHTML = `<p id="detail-client-name" class="font-semibold"></p>`;
                document.getElementById('client-phone-wrapper').innerHTML = `<p id="detail-client-phone" class="font-semibold"></p>`;
                document.getElementById('odometer-display-wrapper').innerHTML = `<p id="detail-odometer" class="font-semibold"></p>`;
                document.getElementById('new-vehicle-number').value = vehicleNumber;
                populateExecutiveVehicleDropdowns();
                createVehicleSection.classList.remove('hidden');
            }
        }
        async function populateExecutiveVehicleDropdowns() {
            if (vehicleModelsCache.length === 0) { 
                const { data, error } = await sb.from('vehicle_models').select('*');
                if (error) return showError('Could not fetch vehicle models.');
                vehicleModelsCache = data;
            }
            const brandSelect = document.getElementById('new-vehicle-brand-exec');
            brandSelect.innerHTML = '<option value="">Select Brand</option>';
            const uniqueBrands = [...new Set(vehicleModelsCache.map(item => item.brand))];
            uniqueBrands.forEach(brand => {
                const opt = document.createElement('option');
                opt.value = brand;
                opt.textContent = brand;
                brandSelect.appendChild(opt);
            });
            populateModelDropdown();
        }
        function populateModelDropdown() {
            const brand = document.getElementById('new-vehicle-brand-exec').value;
            const modelSelect = document.getElementById('new-vehicle-model-exec');
            modelSelect.innerHTML = '<option value="">Select Model</option>';
            const modelsForBrand = vehicleModelsCache.filter(item => item.brand === brand);
            modelsForBrand.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id; 
                opt.textContent = item.model;
                modelSelect.appendChild(opt);
            });
        }
	    function checkOdometer() {
            const newOdometerInput = document.getElementById('detail-odometer-input');
            const warningSpan = document.getElementById('odometer-warning');
            const newOdometerValue = parseInt(newOdometerInput.value);
            if (newOdometerValue < currentOdometer) {
                warningSpan.textContent = 'Reading is lower than last service!';
                warningSpan.classList.remove('hidden');
                newOdometerInput.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            } else {
                warningSpan.textContent = '';
                warningSpan.classList.add('hidden');
                newOdometerInput.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
            }
        }
        async function createVehicle() {
            const newVehicle = {
                vehicle_no: normalizeVehicleNumber(document.getElementById('new-vehicle-number').value),
                model_id: document.getElementById('new-vehicle-model-exec').value,
                fuel_type: document.getElementById('new-fuel-type').value,
                odometer: document.getElementById('new-odometer').value,
                vehicle_name: document.getElementById('new-vehicle-name').value.trim(),
                color: document.getElementById('new-color').value.trim(),
                engine_no: document.getElementById('new-engine-no').value.trim(),
                chassis_no: document.getElementById('new-chassis-no').value.trim(),
                client_name: document.getElementById('new-client-name').value.trim(),
                client_phone: document.getElementById('new-client-phone').value.trim()
            };
            if (!newVehicle.model_id || !newVehicle.fuel_type || !newVehicle.odometer || !newVehicle.client_name || !newVehicle.client_phone || !newVehicle.engine_no || !newVehicle.chassis_no) return showError('Please fill all mandatory vehicle details.');
            if (!/^\d{10}$/.test(newVehicle.client_phone)) return showError('Please enter a valid 10-digit phone number.');
            const { data, error } = await sb.from('vehicles').insert(newVehicle).select().single();
            if (error) return showError(`Failed to create vehicle: ${error.message}`);
            currentVehicleId = data.id;
            document.getElementById('create-vehicle-form').reset();
            createVehicleSection.classList.add('hidden');
            showSuccessMessage('Vehicle created successfully!');
            searchVehicle();
        }
        function addComplaint() {
            const complaintInput = document.getElementById('complaint-input');
            const complaintText = complaintInput.value.trim();
            if (complaintText) {
                currentComplaints.push(complaintText);
                complaintInput.value = '';
                renderComplaints();
            }
            complaintInput.focus();
        }
        function deleteComplaint(index) {
            currentComplaints.splice(index, 1);
            renderComplaints();
        }
        function renderComplaints() {
            const list = document.getElementById('complaints-list');
            list.innerHTML = '';
            if (currentComplaints.length === 0) { list.innerHTML = '<p class="text-sm text-gray-500">No complaints added yet.</p>'; return; }
            currentComplaints.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg text-sm';
                item.innerHTML = `<p class="flex-1 mr-2">${text}</p><button onclick="deleteComplaint(${index})" class="text-red-500 hover:text-red-700 shrink-0"><span class="material-symbols-outlined">delete</span></button>`;
                list.appendChild(item);
            });
        }
		async function saveComplaints() {
            addComplaint(); 
            if (currentComplaints.length === 0) return showError('Please add at least one complaint.');
            if (!currentVehicleId) return showError('No vehicle selected.');
            if ((capturedPhotos.length > 0 || voiceNoteBlob) && !gapi.client.getToken()) {
                showError('Google Drive access required for media upload. Please authorize on the Profile page.');
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) { showError('Authorization failed. Please try again.'); throw (resp); }
                    updateAuthUI(true);
                    showSuccessMessage('Google Drive authorized. Now saving...');
                    await saveComplaints();
                };
                tokenClient.requestAccessToken({prompt: 'consent'});
                return;
            }
            const newOdometerInput = document.getElementById('detail-odometer-input');
            const serviceOdometer = newOdometerInput.value;
            const serviceClientName = document.getElementById('detail-client-name-input').value.trim();
            const serviceClientPhone = document.getElementById('detail-client-phone-input').value.trim();
            if (!/^\d{10}$/.test(serviceClientPhone)) return showError('Please enter a valid 10-digit phone number for the client.');
            if (!serviceClientName) return showError('Client name cannot be empty.');
            showSuccessMessage('Saving report...');
            const { data: reportData, error: reportError } = await sb.from('reports').insert({
                vehicle_id: currentVehicleId, executive_id: currentUser.id, complaint: JSON.stringify(currentComplaints), status: 'Not Started', marks: JSON.stringify(damageMarks), odometer_reading: serviceOdometer, client_name: serviceClientName, client_phone: serviceClientPhone
            }).select('id').single();
            if(reportError) { console.error("Error saving report:", reportError); return showError(`Failed to save complaints: ${reportError.message}`); }
            const reportId = reportData.id;
            const vehicleNo = document.getElementById('detail-vehicle-number').textContent || `Vehicle-${currentVehicleId}`;
            const jobFolderName = `${vehicleNo}_${reportId}`;
            try {
                if (capturedPhotos.length > 0 || voiceNoteBlob) {
                    const folderId = await createDriveFolder(jobFolderName);
                    const uploadPromises = [];
                    capturedPhotos.forEach((photo, index) => uploadPromises.push(uploadFileToDrive(folderId, photo, `photo_${index + 1}.jpg`)));
                    if (voiceNoteBlob) uploadPromises.push(uploadFileToDrive(folderId, voiceNoteBlob, 'voice_note.webm'));
                    await Promise.all(uploadPromises);
                    const folderUrl = `https://drive.google.com/drive/folders/${folderId}`;
                    const { error: updateError } = await sb.from('reports').update({ gdrive_folder_url: folderUrl }).eq('id', reportId);
                    if (updateError) throw updateError;
                    showSuccessMessage('Media uploaded successfully!');
                }
            } catch (driveError) {
                console.error('Google Drive or DB Update Error:', driveError);
                showError('Report saved, but media upload or linking failed.');
            }
            const updates = {};
            const newOdometer = parseInt(serviceOdometer);
            if (newOdometer > currentOdometer) updates.odometer = newOdometer;
            if (serviceClientName !== originalClientName) updates.client_name = serviceClientName;
            if (serviceClientPhone !== originalClientPhone) updates.client_phone = serviceClientPhone;
            if (Object.keys(updates).length > 0) {
                const { error: vehicleUpdateError } = await sb.from('vehicles').update(updates).eq('id', currentVehicleId);
                if(vehicleUpdateError) { console.error("Error updating vehicle details:", vehicleUpdateError); showError('Report saved, but failed to update vehicle details.'); }
            }
            showSuccessMessage('Job Card saved successfully!');
            resetJobCardState();
        }
        
        // --- UPDATES, APPROVALS, & WHATSAPP ---
        async function handleReportUpdateSearch() {
            const input = document.getElementById('update-search-input').value.trim().toUpperCase();
            predictionList.innerHTML = '';
            if (!input) { predictionList.classList.add('hidden'); return; }
            const { data: vehiclesData } = await sb.from('vehicles').select('id').ilike('vehicle_no', `%${input}%`);
            if (!vehiclesData || vehiclesData.length === 0) { predictionList.classList.add('hidden'); return; }
            const vehicleIds = vehiclesData.map(v => v.id);
            const { data } = await sb.from('reports').select(`id, complaint, vehicles!inner(vehicle_no)`).in('vehicle_id', vehicleIds).neq('status', 'Completed').limit(5);
            if (!data || data.length === 0) { predictionList.classList.add('hidden'); return; }
            data.forEach(report => {
                const item = document.createElement('div');
                item.className = 'p-3 hover:bg-gray-100 cursor-pointer';
                item.textContent = `${report.vehicles.vehicle_no} - ${formatArrayCell(report.complaint)}`;
                item.onclick = () => selectReportForUpdate(report);
                predictionList.appendChild(item);
            });
            predictionList.classList.remove('hidden');
        }
        async function selectReportForUpdate(reportStub) {
            currentReportId = reportStub.id;
            document.getElementById('update-search-input').value = reportStub.vehicles.vehicle_no;
            predictionList.classList.add('hidden');
            document.getElementById('update-detail-number').textContent = reportStub.vehicles.vehicle_no;
            const { data: fullReport, error } = await sb.from('reports').select('complaint, suggested, approved, materials_required, expected_delivery').eq('id', currentReportId).single();
            if (error) { showError('Could not fetch full report details.'); return; }
            updateDetailsSection.classList.remove('hidden');
            updateFormSection.classList.remove('hidden');
            try {
                originalComplaintsForUpdate = JSON.parse(fullReport.complaint || '[]');
                const suggested = JSON.parse(fullReport.suggested || '[]');
                newSuggestions = suggested.filter(s => !originalComplaintsForUpdate.includes(s));
                currentMaterials = JSON.parse(fullReport.materials_required || '[]');
            } catch (e) { console.error("Could not parse data:", e); originalComplaintsForUpdate = []; newSuggestions = []; currentMaterials = []; }
            
            document.getElementById('update-detail-complaint').textContent = `${originalComplaintsForUpdate.length} issue(s) registered.`;

            renderSuggestions();
            renderMaterials();
            const approvedItems = JSON.parse(fullReport.approved || '[]');
            document.querySelectorAll('#customer-approval-list input[type="checkbox"]').forEach(checkbox => {
                const labelText = checkbox.nextElementSibling.textContent;
                if (approvedItems.includes(labelText)) checkbox.checked = true;
            });
            document.getElementById('delivery-date').value = fullReport.expected_delivery || '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('delivery-date').setAttribute('min', today);
        }
        function addSuggestion() {
            const input = document.getElementById('suggestion-input');
            const suggestionText = input.value.trim();
            if (suggestionText) {
                newSuggestions.push(suggestionText);
                input.value = '';
                renderSuggestions();
            }
        }
        function deleteSuggestion(index) {
            newSuggestions.splice(index, 1);
            renderSuggestions();
        }
        function renderSuggestions() {
            const executiveList = document.getElementById('executive-suggestions-list');
            const customerList = document.getElementById('customer-approval-list');
            executiveList.innerHTML = '';
            customerList.innerHTML = '';
            const allSuggestionsForApproval = [...originalComplaintsForUpdate, ...newSuggestions];
            if (newSuggestions.length > 0) {
                newSuggestions.forEach((text, index) => {
                    const execItem = document.createElement('div');
                    execItem.className = 'flex items-center justify-between bg-blue-50 p-2 rounded-lg text-sm text-blue-800';
                    execItem.innerHTML = `<p class="flex-1 mr-2">${text}</p><button type="button" onclick="deleteSuggestion(${index})" class="text-red-500 hover:text-red-700 shrink-0"><span class="material-symbols-outlined">delete</span></button>`;
                    executiveList.appendChild(execItem);
                });
            } else executiveList.innerHTML = '<p class="text-sm text-gray-500">No new suggestions added yet.</p>';
            if (allSuggestionsForApproval.length > 0) {
                allSuggestionsForApproval.forEach(text => {
                    const customerItem = document.createElement('label');
                    customerItem.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100';
                    customerItem.innerHTML = `<input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><span class="flex-1">${text}</span>`;
                    customerList.appendChild(customerItem);
                });
            } else customerList.innerHTML = '<p class="text-sm text-gray-500">No complaints registered for this vehicle.</p>';
        }
        function addMaterial() {
            const input = document.getElementById('material-input');
            const materialText = input.value.trim();
            if (materialText) {
                currentMaterials.push(materialText);
                input.value = '';
                renderMaterials();
            }
        }
        function deleteMaterial(index) {
            currentMaterials.splice(index, 1);
            renderMaterials();
        }
        function renderMaterials() {
            const list = document.getElementById('materials-list');
            list.innerHTML = '';
            if (currentMaterials.length === 0) { list.innerHTML = '<p class="text-sm text-gray-500">No materials added yet.</p>'; return; }
            currentMaterials.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg text-sm';
                item.innerHTML = `<p class="flex-1 mr-2">${text}</p><button type="button" onclick="deleteMaterial(${index})" class="text-red-500 hover:text-red-700 shrink-0"><span class="material-symbols-outlined">delete</span></button>`;
                list.appendChild(item);
            });
        }
        async function saveVehicleUpdate(resetAfterSave = true) {
            if(!currentReportId) return showError('No report selected for update.');
            const deliveryDate = document.getElementById('delivery-date').value;
            const approvedItems = [];
            document.querySelectorAll('#customer-approval-list input[type="checkbox"]:checked').forEach(checkbox => { approvedItems.push(checkbox.nextElementSibling.textContent); });
            const allSuggestions = [...originalComplaintsForUpdate, ...newSuggestions];
            const updateData = {
                suggested: JSON.stringify(allSuggestions),
                approved: JSON.stringify(approvedItems),
                expected_delivery: deliveryDate || null,
                status: 'Ongoing',
                materials_required: JSON.stringify(currentMaterials)
            };
            const { error } = await sb.from('reports').update(updateData).eq('id', currentReportId);
            if(error) { console.error("Update Error:", error); return showError(`Failed to save update: ${error.message}`); }
            if (resetAfterSave) {
                showSuccessMessage('Update saved successfully!');
                resetVehicleUpdateScreen();
            }
        }
        async function sendApprovalLink() {
            if (!currentReportId) return showError('Please save the current selections before sending a link.');
            await saveVehicleUpdate(false); 
            const { data: reportData, error: reportError } = await sb.from('reports').select('client_phone, vehicles(client_phone)').eq('id', currentReportId).single();
            if (reportError) { console.error("Error fetching report details:", reportError); return showError("Could not fetch report details to send the link."); }
            const clientPhone = reportData.client_phone || reportData.vehicles?.client_phone;
            if (!clientPhone) return showError("A client phone number could not be found for this report or vehicle.");
            const yourVercelLink = "https://auto-fix-index.vercel.app/"; // <-- REPLACE THIS WITH YOUR ACTUAL VERCEL DEPLOYMENT LINK
            const approvalUrl = `${yourVercelLink}?report_id=${currentReportId}`;
            let messageText = `Dear Customer,\n\nPlease review and approve the suggested repairs for your vehicle using the link below:\n${approvalUrl}\n\nThank you,\nAutoFix Service`;
            const encodedText = encodeURIComponent(messageText);
            const whatsappUrl = `https://wa.me/91${clientPhone}?text=${encodedText}`;
            window.open(whatsappUrl, '_blank');
            showSuccessMessage("Opening WhatsApp...");
        }

        // --- DUE DATES & PROFILE ---
        async function populateDueDateScreen() {
            const listContainer = document.getElementById('due-date-list');
            const noDatesMsg = document.getElementById('no-due-dates-message');
            listContainer.innerHTML = '';
            const { data, error } = await sb.from('reports').select(`id, complaint, expected_delivery, status, vehicles!inner(vehicle_no)`).eq('executive_id', currentUser.id).in('status', ['Not Started', 'Ongoing']).order('expected_delivery', { ascending: true, nullsfirst: false });
            if(error) return showError('Could not fetch due dates.');
            if (!data || data.length === 0) { noDatesMsg.classList.remove('hidden'); return; }
            noDatesMsg.classList.add('hidden');
            const groupedJobs = {};
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
            data.forEach(job => {
                if (!job.expected_delivery) return; 
                const dueDate = new Date(job.expected_delivery + 'T00:00:00Z');
                let groupKey = '', sortKey = job.expected_delivery;
                if (dueDate < today) { groupKey = 'Overdue'; sortKey = `1-${job.expected_delivery}`; }
                else if (dueDate.getTime() === today.getTime()) { groupKey = 'Today'; sortKey = `2-${job.expected_delivery}`; }
                else if (dueDate.getTime() === tomorrow.getTime()) { groupKey = 'Tomorrow'; sortKey = `3-${job.expected_delivery}`; }
                else { groupKey = dueDate.toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' }); sortKey = `4-${job.expected_delivery}`; }
                if (!groupedJobs[groupKey]) groupedJobs[groupKey] = { jobs: [], sortKey: sortKey };
                groupedJobs[groupKey].jobs.push(job);
            });
            const sortedGroupKeys = Object.keys(groupedJobs).sort((a, b) => groupedJobs[a].sortKey.localeCompare(groupedJobs[b].sortKey));
            sortedGroupKeys.forEach(groupKey => {
                const group = groupedJobs[groupKey];
                 if (group.jobs.length > 0) {
                    const header = document.createElement('div');
                    const isImmediate = groupKey === 'Overdue' || groupKey === 'Today';
                    let headerColor = isImmediate ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-700';
                    header.className = `py-2 px-4 ${headerColor} rounded-lg text-sm font-bold sticky top-[64px] z-10`; 
                    header.textContent = `${groupKey} (${group.jobs.length})`;
                    listContainer.appendChild(header);
                    const sortedJobs = group.jobs.sort((a, b) => a.vehicles.vehicle_no.localeCompare(b.vehicles.vehicle_no));
                    sortedJobs.forEach(job => {
                        const itemContainer = document.createElement('div');
                        const itemBorderClass = isImmediate ? 'border-l-4 border-l-red-500' : 'border-l-4 border-l-transparent';
                        itemContainer.className = `due-date-item bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden ${itemBorderClass}`;
                        const statusOptions = ['Not Started', 'Ongoing', 'Completed'];
                        let optionsHtml = statusOptions.map(opt => `<option value="${opt}" ${job.status === opt ? 'selected' : ''}>${opt}</option>`).join('');
                        itemContainer.innerHTML = `<div class="due-date-header p-4 flex justify-between items-center cursor-pointer" onclick="toggleDueDateItem(this.parentElement)"><div><p class="font-bold text-gray-800">${job.vehicles.vehicle_no}</p><p class="text-sm text-gray-500">${job.status}</p></div><span class="material-symbols-outlined transition-transform duration-300">expand_more</span></div><div class="due-date-details"><div class="p-4 border-t border-gray-200"><p class="text-sm text-gray-600 mb-4"><strong>Complaint:</strong> ${formatArrayCell(job.complaint)}</p><div class="flex items-center gap-3"><label class="text-sm font-medium text-gray-600 shrink-0">Update Status:</label><select onchange="updateJobStatus(${job.id}, this.value, '${job.vehicles.vehicle_no}')" class="form-input text-sm !py-1.5 !px-2 w-full">${optionsHtml}</select></div></div></div>`;
                        listContainer.appendChild(itemContainer);
                    });
                }
            });
        }
        function toggleDueDateItem(element) {
            const isExpanded = element.classList.contains('expanded');
            document.querySelectorAll('.due-date-item.expanded').forEach(item => { if (item !== element) item.classList.remove('expanded'); });
            if (isExpanded) element.classList.remove('expanded');
            else element.classList.add('expanded');
        }
        async function updateJobStatus(id, newStatus, vehicleNo) {
            const { error } = await sb.from('reports').update({ status: newStatus }).eq('id', id);
            if(error) return showError('Failed to update status.');
            showSuccessMessage(`Status for ${vehicleNo} updated to ${newStatus}`);
            setTimeout(populateDueDateScreen, 500); 
        }
        async function resetPassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            if (newPassword !== confirmNewPassword) return showError('New passwords do not match.');
            if (currentUser.password !== currentPassword) return showError('Incorrect current password.');
            const { error } = await sb.from('users').update({ password: newPassword }).eq('id', currentUser.id);
            if (error) return showError('Could not reset password.');
            showSuccessMessage('Password reset successfully!');
            currentUser.password = newPassword; 
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            document.querySelector('#profile-screen form').reset();
        }

        // --- GOOGLE DRIVE ---
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true;
            checkInitialAuth();
        }
        function checkInitialAuth() {
            if (gapiInited && gisInited && sessionStorage.getItem('currentUser')) {
                updateAuthUI(gapi.client.getToken() !== null);
            }
        }
        function updateAuthUI(isSignedIn) {
            const authButton = document.getElementById('auth-button');
            const signOutButton = document.getElementById('signout-button');
            if(authButton && signOutButton) {
                if (isSignedIn) {
                    signOutButton.classList.remove('hidden');
                    authButton.textContent = 'Google Drive Authorized';
                    authButton.disabled = true;
                } else {
                    signOutButton.classList.add('hidden');
                    authButton.textContent = 'Authorize Google Drive';
                    authButton.disabled = false;
                }
            }
        }
        function handleAuthClick() {
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'});
        }
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateAuthUI(false);
                });
            }
        }
        async function createDriveFolder(folderName) {
            const fileMetadata = { 'name': folderName, 'mimeType': 'application/vnd.google-apps.folder', 'parents': [PARENT_FOLDER_ID] };
            const response = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
            return response.result.id;
        }
        async function uploadFileToDrive(folderId, file, fileName) {
            const metadata = { name: fileName, parents: [folderId] };
            const formData = new FormData();
            formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            formData.append('file', file);
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({'Authorization': 'Bearer ' + gapi.client.getToken().access_token}),
                body: formData
            });
            return response.json();
        }
        
        // --- CUSTOMER PORTAL ---
        async function initializeCustomerView(reportId) {
            showScreen('customer-approval-screen');
            currentReportId = reportId;
            const { data, error } = await sb.from('reports').select(`suggested, approved, customer_feedback_text, vehicles!inner(vehicle_no, vehicle_models!inner(brand, model), vehicle_name)`).eq('id', reportId).single();
            if (error || !data) {
                document.getElementById('customer-loading').innerHTML = `<p class="text-lg text-red-600">Error: Could not load report details. The link may be invalid.</p>`;
                return;
            }
            document.getElementById('cust-vehicle-no').textContent = data.vehicles.vehicle_no;
            document.getElementById('cust-vehicle-name').textContent = data.vehicles.vehicle_name || `${data.vehicles.vehicle_models.brand} ${data.vehicles.vehicle_models.model}`;
            const suggestions = JSON.parse(data.suggested || '[]');
            const alreadyApproved = JSON.parse(data.approved || '[]');
            const approvalList = document.getElementById('cust-approval-list');
            approvalList.innerHTML = '';
            if (suggestions.length > 0) {
                suggestions.forEach(item => {
                    const isChecked = alreadyApproved.includes(item);
                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors';
                    label.innerHTML = `<input type="checkbox" class="h-6 w-6 rounded-md border-gray-300 text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}><span class="flex-1 font-medium text-gray-800">${item}</span>`;
                    approvalList.appendChild(label);
                });
            } else approvalList.innerHTML = '<p class="text-gray-600">No specific repairs were suggested for approval at this time.</p>';
            document.getElementById('customer-feedback-text').value = data.customer_feedback_text || '';
            document.getElementById('customer-loading').classList.add('hidden');
            document.getElementById('customer-approval-content').classList.remove('hidden');
        }
        async function toggleRecording() {
            const recordBtn = document.getElementById('cust-record-btn');
            const recordBtnText = document.getElementById('cust-record-btn-text');
            const statusEl = document.getElementById('cust-recording-status');
            const playbackEl = document.getElementById('cust-audio-playback');
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                recordBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                recordBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                recordBtnText.textContent = 'Start Recording';
                statusEl.textContent = 'Recording stopped.';
            } else {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert('Audio recording is not supported in your browser.'); return; }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    recordedAudioBlob = null;
                    playbackEl.src = '';
                    playbackEl.classList.add('hidden');
                    mediaRecorder.ondataavailable = event => { audioChunks.push(event.data); };
                    mediaRecorder.onstop = () => {
                        recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                        const audioUrl = URL.createObjectURL(recordedAudioBlob);
                        playbackEl.src = audioUrl;
                        playbackEl.classList.remove('hidden');
                        recordBtn.classList.add('hidden');
                    };
                    mediaRecorder.start();
                    recordBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    recordBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    recordBtnText.textContent = 'Stop Recording';
                    statusEl.textContent = 'Recording in progress...';
                } catch (err) { console.error("Audio recording error:", err); alert("Could not start recording. Please ensure microphone permissions are granted."); }
            }
        }
        async function submitCustomerApproval() {
            const approvedItems = [];
            document.querySelectorAll('#cust-approval-list input[type="checkbox"]:checked').forEach(cb => { approvedItems.push(cb.nextElementSibling.textContent); });
            const feedbackText = document.getElementById('customer-feedback-text').value.trim();
            const updatePayload = { approved: JSON.stringify(approvedItems), customer_feedback_text: feedbackText, };
            showSuccessMessage("Submitting your response...");
            if (recordedAudioBlob) {
                const filePath = `feedback-audio/${currentReportId}_${Date.now()}.webm`;
                const { data: uploadData, error: uploadError } = await sb.storage.from('customer-media').upload(filePath, recordedAudioBlob);
                if (uploadError) { showError('Failed to upload voice note. Please try again.'); console.error("Upload Error:", uploadError); return; }
                const { data: urlData } = sb.storage.from('customer-media').getPublicUrl(filePath);
                updatePayload.customer_feedback_audio = urlData.publicUrl;
            }
            const { error: dbError } = await sb.from('reports').update(updatePayload).eq('id', currentReportId);
            if (dbError) { showError('Could not save your approval. Please try again.'); console.error("DB Update Error:", dbError); return; }
            document.getElementById('customer-approval-content').classList.add('hidden');
            document.getElementById('customer-thank-you').classList.remove('hidden');
        }

        // --- UTILITY & SETUP ---
        function confirmDeletion(type, id, role) {
            const modal = document.getElementById('delete-confirmation-modal');
            const text = document.getElementById('delete-modal-text');
            const button = document.getElementById('confirm-delete-button');
            let message = '';
            if (type === 'user') message = `Are you sure you want to delete this ${role}? This action cannot be undone.`;
            else if (type === 'vehicle_model') message = `Are you sure you want to delete this vehicle model? This may affect existing records.`;
            text.textContent = message;
            button.onclick = () => executeDelete(type, id, role);
            showModal('delete-confirmation-modal');
        }
        async function executeDelete(type, id, role) {
            let error;
            if (type === 'user') ({ error } = await sb.from('users').delete().eq('id', id));
            else if (type === 'vehicle_model') ({ error } = await sb.from('vehicle_models').delete().eq('id', id));
            hideModal('delete-confirmation-modal');
            if(error) return showError(`Deletion failed: ${error.message}`);
            showSuccessMessage('Item deleted successfully.');
            if (type === 'user') renderUserList(role);
            if (type === 'vehicle_model') renderVehicleModelList();
        }
        const formatArrayCell = (jsonString) => {
            if (!jsonString || jsonString === '[]') return 'N/A';
            try { const arr = JSON.parse(jsonString); return Array.isArray(arr) && arr.length > 0 ? arr.join(', ') : 'N/A'; }
            catch (e) { return jsonString; }
        };
        function hideAllSections() {
            vehicleDetailsSection.classList.add('hidden');
            createVehicleSection.classList.add('hidden');
            newComplaintSection.classList.add('hidden');
            searchError.classList.add('hidden');
        }
        function resetJobCardState() {
            hideAllSections();
            document.getElementById('search-vehicle-number').value = '';
            document.getElementById('create-vehicle-form').reset();
            currentVehicleId = null;
            currentComplaints = [];
            renderComplaints();
            document.getElementById('client-name-wrapper').innerHTML = `<p id="detail-client-name" class="font-semibold"></p>`;
            document.getElementById('client-phone-wrapper').innerHTML = `<p id="detail-client-phone" class="font-semibold"></p>`;
            document.getElementById('odometer-display-wrapper').innerHTML = `<p id="detail-odometer" class="font-semibold"></p>`;
            clearDamageCanvas();
            capturedPhotos = [];
            voiceNoteBlob = null;
            document.getElementById('photo-previews').innerHTML = '';
            document.getElementById('audio-playback').innerHTML = '';
            document.getElementById('recording-status').textContent = '';
        }
        function resetVehicleUpdateScreen() {
            document.getElementById('update-search-input').value = '';
            predictionList.classList.add('hidden');
            updateDetailsSection.classList.add('hidden');
            updateFormSection.classList.add('hidden');
            document.getElementById('delivery-date').value = '';
            newSuggestions = [];
            currentMaterials = [];
            currentReportId = null;
            renderSuggestions();
            renderMaterials();
        }
        function resizeCanvas() {
            if (!carImage || !damageCanvas || !checkCanvas) return;
            const redraw = () => {
                const w = carImage.clientWidth;
                const h = carImage.clientHeight;
                if (w === 0 || h === 0) return;
                damageCanvas.width = w; damageCanvas.height = h;
                checkCanvas.width = w; checkCanvas.height = h;
                checkCtx.drawImage(carImage, 0, 0, w, h);
                redrawDamageMarks(damageCanvas, damageMarks);
            };
            requestAnimationFrame(redraw);
        }
        function undoLastMark() {
            if (damageMarks.length > 0) { damageMarks.pop(); redrawDamageMarks(damageCanvas, damageMarks); }
        }
        function clearDamageCanvas() {
            if (damageCtx) damageCtx.clearRect(0, 0, damageCanvas.width, damageCanvas.height);
            damageMarks = [];
        }
        function redrawDamageMarks(canvas, marks) {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!marks) return;
            marks.forEach(mark => {
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(mark.x, mark.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        function openMarksModal(marks) {
            const marksArray = typeof marks === 'string' ? JSON.parse(marks) : marks;
            const modal = document.getElementById("marks-modal");
            modal.classList.remove("modal-hidden");
            const modalCanvas = document.getElementById("modalCanvas");
            const modalImage = document.getElementById("modalCarImage");
            const drawOnModal = () => {
                modalCanvas.width = modalImage.clientWidth;
                modalCanvas.height = modalImage.clientHeight;
                redrawDamageMarks(modalCanvas, marksArray);
            };
            if (modalImage.complete) drawOnModal();
            else modalImage.onload = drawOnModal;
        }
        function closeMarksModal() { document.getElementById("marks-modal").classList.add("modal-hidden"); }
        function showScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); document.getElementById(screenId).classList.add('active-screen'); }
        function showAdminScreen(screenId) {
            document.querySelectorAll('#admin-screens .admin-screen').forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
            if (screenId === 'admin-vehicle-management-screen') renderVehicleModelList();
            if (screenId === 'admin-reports-screen') fetchAndPopulateReports(true);
            if (screenId === 'admin-analytics-screen') { populateAnalyticsFilters(); renderAnalytics(); }
            if (screenId === 'admin-executive-management-screen') renderUserList('executive');
            if (screenId === 'admin-admin-management-screen') renderUserList('admin');
            showScreen('admin-screens');
        }
        function showExecutiveScreen(screenId) {
            document.querySelectorAll('#executive-screens .executive-screen').forEach(s => s.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
            setActiveNav(screenId);
            if (screenId === 'report-screen') fetchAndPopulateReports(false);
            if (screenId === 'due-date-screen') populateDueDateScreen();
            if (screenId === 'job-card-screen') resetJobCardState();
            showScreen('executive-screens');
        }
        function setActiveNav(targetId) {
            const headerTitle = document.getElementById('executive-header-title');
            document.querySelectorAll('.nav-item').forEach(item => {
                const isActive = item.dataset.target === targetId;
                item.classList.toggle('active', isActive);
                if (isActive) headerTitle.textContent = item.querySelector('span:last-child').textContent;
            });
        }
        function showModal(id) { document.getElementById(id)?.classList.remove('modal-hidden'); }
        function hideModal(id) { document.getElementById(id)?.classList.add('modal-hidden'); }
        function showSuccessMessage(message) {
            const el = document.getElementById('success-message');
            document.getElementById('success-text').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }
        function showError(message) {
            const el = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 4000);
        }
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const reportIdFromUrl = urlParams.get('report_id');
            if (reportIdFromUrl) {
                initializeCustomerView(reportIdFromUrl);
            } else {
                const savedUser = sessionStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser.role === 'admin') showAdminScreen('admin-dashboard-screen');
                    else if (currentUser.role === 'executive') {
                        document.getElementById('profile-username').textContent = currentUser.username;
                        document.getElementById('profile-role').textContent = currentUser.role;
                        showExecutiveScreen('job-card-screen');
                    }
                }
                carImage = document.getElementById("carImage");
                damageCanvas = document.getElementById("damageCanvas");
                checkCanvas = document.getElementById("checkCanvas");
                if (carImage && damageCanvas && checkCanvas) {
                    damageCtx = damageCanvas.getContext("2d");
                    checkCtx = checkCanvas.getContext("2d");
                    carImage.onload = resizeCanvas;
                    window.addEventListener("resize", resizeCanvas);
                    damageCanvas.addEventListener("click", (e) => {
                        if (!checkCtx) return;
                        const rect = damageCanvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        const pixel = checkCtx.getImageData(x, y, 1, 1).data;
                        const alpha = pixel[3];
                        if (alpha > 0) {
                            damageCtx.fillStyle = "red";
                            damageCtx.beginPath();
                            damageCtx.arc(x, y, 5, 0, Math.PI * 2);
                            damageCtx.fill();
                            damageMarks.push({ x, y });
                        }
                    });
                }
            }
        });
        function printJobCardById(reportId) {
            const reportData = reportsDataStore[reportId];
            if (reportData) printJobCard(reportData);
            else { console.error(`Report data not found for ID: ${reportId}`); showError("Could not find report data to print."); }
        }
        function printJobCard(reportData) {
            document.getElementById('print-report-date').textContent = new Date(reportData.created_at).toLocaleString();
            document.getElementById('print-executive-name').textContent = reportData.users.username || 'N/A';
            document.getElementById('print-vehicle-no').textContent = reportData.vehicles.vehicle_no || 'N/A';
            document.getElementById('print-vehicle-name').textContent = `${reportData.vehicles.vehicle_models.brand} ${reportData.vehicles.vehicle_models.model}`;
            document.getElementById('print-engine-chassis').textContent = `${reportData.vehicles.engine_no || 'N/A'} / ${reportData.vehicles.chassis_no || 'N/A'}`;
			document.getElementById('print-client-name').textContent = reportData.client_name || 'N/A';
			document.getElementById('print-client-phone').textContent = reportData.client_phone || 'N/A';
			document.getElementById('print-odometer').textContent = reportData.odometer_reading || 'N/A';
            const populateList = (listId, dataString) => {
                const list = document.getElementById(listId);
                list.innerHTML = '';
                try {
                    const items = JSON.parse(dataString);
                    if (items && items.length > 0) items.forEach(item => { const li = document.createElement('li'); li.textContent = item; list.appendChild(li); });
                    else list.innerHTML = '<li>N/A</li>';
                } catch(e) { list.innerHTML = '<li>N/A</li>'; }
            };
            populateList('print-complaints-list', reportData.complaint);
            populateList('print-suggested-list', reportData.suggested);
            populateList('print-approved-list', reportData.approved);
            populateList('print-materials-list', reportData.materials_required);
            const printImage = document.getElementById('print-car-image');
            const printCanvas = document.getElementById('print-damage-canvas');
            const marksArray = reportData.marks ? JSON.parse(reportData.marks) : [];
            const drawMarksAndPrint = () => {
                const sourceWidth = 384; 
                const aspectRatio = printImage.naturalWidth / printImage.naturalHeight;
                const sourceHeight = sourceWidth / aspectRatio;
                const destWidth = 400; const destHeight = destWidth / aspectRatio;
                printCanvas.width = destWidth; printCanvas.height = destHeight;
                const widthRatio = destWidth / sourceWidth; const heightRatio = destHeight / sourceHeight;
                const scaledMarks = marksArray.map(mark => ({ x: mark.x * widthRatio, y: mark.y * heightRatio }));
                redrawDamageMarks(printCanvas, scaledMarks);
                window.print();
            };
            if (printImage.complete) drawMarksAndPrint();
            else printImage.onload = drawMarksAndPrint;
        }
		function downloadReport() {
            const isAdminScreenActive = document.getElementById('admin-screens').classList.contains('active-screen');
            const table = isAdminScreenActive ? document.querySelector('#admin-reports-screen .report-table') : document.querySelector('#report-screen .report-table');
            if (!table) return showError('Could not find the report table.');
            const rows = table.querySelectorAll('tr');
            if (rows.length <= 1) return showError('No data available to download.');
            let csv = [];
            const formatCell = (cellText) => {
                let text = cellText.replace(/"/g, '""');
                if (text.search(/("|,|\n)/g) >= 0) text = `"${text}"`;
                return text;
            };
            const headers = [];
            rows[0].querySelectorAll('th').forEach(th => headers.push(formatCell(th.textContent.trim())));
            csv.push(headers.join(','));
            for (let i = 1; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td');
                for (let j = 0; j < cols.length; j++) {
                    if (j === 0) row.push(formatCell(cols[j].querySelector('span:last-child').textContent.trim()));
                    else if (cols[j].querySelector('button')) row.push('See in App');
                    else if (cols[j].querySelector('audio')) row.push('Has Voice Note');
                    else row.push(formatCell(cols[j].textContent.trim()));
                }
                csv.push(row.join(','));
            }
            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
            const downloadLink = document.createElement('a');
            const today = new Date().toISOString().slice(0, 10);
            downloadLink.download = `AutoFix_Report_${today}.csv`;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            showSuccessMessage("Report is downloading...");
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>

