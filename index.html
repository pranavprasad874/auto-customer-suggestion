<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AutoFix Service Approval</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style type="text/tailwindcss">
        :root {
            --primary-color: #2563eb; /* Blue 600 */
            --primary-hover: #1d4ed8; /* Blue 700 */
            --background-color: #f9fafb; /* Gray 50 */
            --card-background: #ffffff;
            --border-color: #e5e7eb; /* Gray 200 */
            --text-primary: #111827; /* Gray 900 */
            --text-secondary: #6b7280; /* Gray 500 */
            --text-on-primary: #ffffff;
        }
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
        }
        .card { @apply bg-[var(--card-background)] p-5 rounded-xl border border-[var(--border-color)] shadow-sm; }
        .app-header { @apply bg-white border-b border-[var(--border-color)] sticky top-0 z-10; }
        .app-header-content { @apply max-w-7xl mx-auto p-4 flex justify-between items-center relative; }
        .app-main { @apply p-4 max-w-4xl mx-auto space-y-6; }
        .form-input { @apply w-full rounded-lg border-[var(--border-color)] text-base shadow-sm transition-colors focus:border-[var(--primary-color)] focus:ring focus:ring-[var(--primary-color)] focus:ring-opacity-50; }
        .btn-primary { @apply w-full flex justify-center items-center gap-2 rounded-lg bg-[var(--primary-color)] text-[var(--text-on-primary)] font-bold py-3 px-4 shadow-sm hover:bg-[var(--primary-hover)] transition-all duration-300 transform hover:scale-[1.02]; }
        .btn-secondary { @apply w-full flex justify-center items-center gap-2 rounded-lg bg-gray-600 text-white font-bold py-3 px-4 shadow-sm hover:bg-gray-700 transition-colors; }
    </style>
</head>
<body>
    <div id="customer-approval-screen">
        <header class="app-header">
            <div class="app-header-content">
                 <h1 class="text-xl sm:text-2xl font-bold text-[var(--primary-color)] flex-1 text-center flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">minor_crash</span> AutoFix Service Approval
                </h1>
            </div>
        </header>
        <main id="customer-approval-main" class="app-main">
            <div id="customer-loading" class="text-center py-10">
                <p class="flex items-center justify-center gap-2 text-lg text-gray-600">
                    <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Loading your service details...
                </p>
            </div>
            <div id="customer-approval-content" class="hidden space-y-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-3">Vehicle Details</h2>
                    <div class="grid grid-cols-2 gap-4 border-t pt-3">
                        <div><p class="text-sm text-gray-500">Vehicle Number</p><p id="cust-vehicle-no" class="font-bold"></p></div>
                        <div><p class="text-sm text-gray-500">Vehicle Name</p><p id="cust-vehicle-name" class="font-bold"></p></div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-3">1. Review and Approve Services</h2>
                    <p class="text-sm text-gray-500 -mt-2 mb-4">Please select all services you wish to approve. Your original requests are pre-selected for your convenience.</p>
                    <div id="cust-suggestions-list" class="space-y-3 border-t pt-4">
                        </div>
<div class="card">
    <h2 class="text-xl font-bold mb-3">1. Review and Approve Services</h2>
    <p class="text-sm text-gray-500 -mt-2 mb-4">Please select all services you wish to approve. Your original requests are pre-selected for your convenience.</p>
    <div id="cust-suggestions-list" class="space-y-3 border-t pt-4">
        </div>
    <div id="customer-total-cost-container" class="border-t mt-4 pt-4 flex justify-between items-center text-lg font-bold">
        <span>Total Estimated Cost:</span>
        <span id="customer-total-cost" class="text-blue-600">â‚¹0</span>
    </div>
</div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-3">2. Additional Feedback (Optional)</h2>
                     <textarea id="customer-feedback-text" class="form-input" rows="4" placeholder="If you have any other concerns or requests, please write them here..."></textarea>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-3">3. Record a Voice Note (Optional)</h2>
                    <p class="text-sm text-gray-500 -mt-2 mb-4">If it's easier, you can record a voice message for our team.</p>
                    <div class="flex items-center gap-3">
    <button id="customer-record-btn" type="button" onclick="startRecording('customer')" class="btn-secondary !w-auto !py-2 !px-3 text-sm flex items-center gap-2">
        <span class="material-symbols-outlined">mic</span> Record
    </button>
    <button id="customer-stop-record-btn" type="button" onclick="stopRecording('customer')" class="btn-primary !w-auto !py-2 !px-3 text-sm flex items-center gap-2 hidden !bg-red-600">
        <span class="material-symbols-outlined">stop_circle</span> Stop
    </button>
</div>
<div id="customer-audio-playback" class="mt-3"></div>
                     <p id="recording-status" class="text-xs text-center mt-2 text-gray-500"></p>
                </div>
                <div id="customer-submit-section">
                    <button onclick="submitCustomerApproval()" class="btn-primary">
                        <span class="material-symbols-outlined">task_alt</span>
                        Submit Approval
                    </button>
                </div>
            </div>
             <div id="customer-thank-you" class="hidden card text-center py-10">
                <span class="material-symbols-outlined text-6xl text-green-500">check_circle</span>
                <h2 class="text-2xl font-bold mt-4">Thank You!</h2>
                <p class="text-gray-600 mt-1">Your approval has been submitted. Our team will get in touch with you shortly.</p>
            </div>
        </main>
    </div>
    
    <div id="error-message" class="fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-lg hidden flex items-center gap-2 transition-transform duration-300 transform"><span class="material-symbols-outlined">error</span><span id="error-text"></span></div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://gfylsjfljnwyomfouwvs.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdmeWxzamZsam53eW9tZm91d3ZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MDc5MTYsImV4cCI6MjA3Mjk4MzkxNn0.hMvLvCDVaFtq0rXToHGOJPSFe-QnJ6_S-MYsI0d5zOs';
        const sb = createClient(supabaseUrl, supabaseKey);

        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioBlob = null;

        function showError(message) {
            const el = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 4000);
        }



       // ADD THESE TWO NEW FUNCTIONS
async function startRecording(context = 'customer') {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showError('Audio recording is not supported on this browser.');
        return;
    }
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        recordedAudioBlob = null;

        mediaRecorder.addEventListener("dataavailable", event => {
            audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", () => {
            recordedAudioBlob = new Blob(audioChunks, { 'type' : 'audio/webm' });
            const audioUrl = URL.createObjectURL(recordedAudioBlob);
            const audioPlaybackEl = document.getElementById('customer-audio-playback');
            audioPlaybackEl.innerHTML = `<audio controls src="${audioUrl}" class="w-full"></audio>`;
            stream.getTracks().forEach(track => track.stop()); // Stop mic access
        });

        mediaRecorder.start();
        document.getElementById('customer-record-btn').classList.add('hidden');
        document.getElementById('customer-stop-record-btn').classList.remove('hidden');
        document.getElementById('recording-status').textContent = 'Recording...';
        document.getElementById('customer-audio-playback').innerHTML = ''; // Clear previous playback
    } catch (err) {
        showError('Microphone access was denied.');
        console.error("Mic Error:", err);
    }
}

    // ADD THIS HELPER FUNCTION
    function ensureObjectFormat(arr) {
        if (!arr || !Array.isArray(arr)) return [];
        return arr.map(item => {
            if (typeof item === 'string') {
                return { text: item, cost: 0 }; // Convert old string data
            }
            item.cost = Number(item.cost) || 0;
            return item;
        });
    }

// REPLACE your existing stopRecording function with this one
function stopRecording(context = 'customer') {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stream.getTracks().forEach(track => track.stop()); // Immediately stop the mic
        mediaRecorder.stop();
        document.getElementById('customer-record-btn').classList.add('hidden'); // Stays hidden to prevent re-record
        document.getElementById('customer-stop-record-btn').classList.add('hidden');
        document.getElementById('recording-status').textContent = 'Recording stopped. Play back audio below.';
    }
}
        
// ADD THIS NEW FUNCTION
function calculateCustomerTotal() {
    let total = 0;
    document.querySelectorAll('#cust-suggestions-list input[type="checkbox"]:checked').forEach(checkbox => {
        total += parseFloat(checkbox.dataset.cost) || 0;
    });
    document.getElementById('customer-total-cost').textContent = `â‚¹${total}`;
}

// REPLACE this function
async function initializeCustomerView(reportId) {
    const { data, error } = await sb.from('reports')
        .select(`complaint, suggested, approved, vehicles(*, vehicle_models(brand, model))`)
        .eq('id', reportId)
        .single();

    if (error || !data) {
        document.getElementById('customer-loading').innerHTML = `<p class="text-red-500 font-bold">Error: Could not load report details. The link may be invalid or expired.</p>`;
        return;
    }
    
    if (data.approved !== null && data.approved !== '[]') {
        document.getElementById('customer-loading').style.display = 'none';
        document.getElementById('customer-approval-content').classList.add('hidden');
        document.getElementById('customer-thank-you').classList.remove('hidden');
        return;
    }

    document.getElementById('cust-vehicle-no').textContent = data.vehicles.vehicle_no;
    document.getElementById('cust-vehicle-name').textContent = `${data.vehicles.vehicle_models.brand} ${data.vehicles.vehicle_models.model}`;
    
    const suggestionsList = document.getElementById('cust-suggestions-list');
    suggestionsList.innerHTML = '';

    try {
        const originalComplaints = ensureObjectFormat(JSON.parse(data.complaint || '[]'));
        const allSuggestions = ensureObjectFormat(JSON.parse(data.suggested || '[]'));
        
        const allItems = [...originalComplaints, ...allSuggestions].reduce((acc, current) => {
            if (!acc.find(item => item.text === current.text)) {
                acc.push(current);
            }
            return acc;
        }, []);


        if (allItems.length > 0) {
             allItems.forEach(item => {
                const isOriginalComplaint = originalComplaints.some(c => c.text === item.text);
                const label = document.createElement('label');
                
                const bgColor = isOriginalComplaint ? 'bg-gray-50' : 'bg-blue-50';
                const textColor = isOriginalComplaint ? 'text-gray-800' : 'text-blue-800';
                const tag = isOriginalComplaint 
                    ? `<span class="text-xs text-gray-500">(Your Request)</span>`
                    : `<span class="text-xs text-blue-600">(Mechanic Suggestion)</span>`;
                const cost = item.cost || 0;

                label.className = `flex items-center gap-3 p-3 ${bgColor} rounded-lg cursor-pointer hover:bg-gray-100 transition-colors`;
                label.innerHTML = `
                    <input type="checkbox" value="${item.text}" data-cost="${cost}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isOriginalComplaint ? 'checked' : ''}>
                    <div class="flex-1">
                        <span class="font-medium ${textColor}">${item.text}</span>
                        ${tag}
                    </div>
                    <span class="font-bold text-gray-700">â‚¹${cost}</span>
                `;
                suggestionsList.appendChild(label);
            });
            // Add event listener for live calculation
            suggestionsList.addEventListener('change', calculateCustomerTotal);
            // Calculate initial total
            calculateCustomerTotal();
        } else {
            suggestionsList.innerHTML = '<p class="text-sm text-gray-500">No services have been suggested for this job.</p>';
            document.getElementById('customer-total-cost-container').style.display = 'none';
        }

    } catch (e) {
        suggestionsList.innerHTML = '<p class="text-sm text-red-500">Could not parse service lists.</p>';
    }

    document.getElementById('customer-loading').style.display = 'none';
    document.getElementById('customer-approval-content').classList.remove('hidden');
}

// REPLACE this function
async function submitCustomerApproval() {
    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('report_id');
    if (!reportId) return showError('Invalid report ID.');

    const submitBtn = document.querySelector('#customer-submit-section button');
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <span>Submitting...</span>`;
    
    const allApprovedItems = [];
    document.querySelectorAll('#cust-suggestions-list input[type="checkbox"]:checked').forEach(checkbox => {
        // Create the object with text and cost
        allApprovedItems.push({
            text: checkbox.value,
            cost: Number(checkbox.dataset.cost) || 0
        });
    });
    
    const feedbackText = document.getElementById('customer-feedback-text').value.trim();
    let audioUrlToUpload = null;

    if (recordedAudioBlob) {
        try {
            const filePath = `feedback_audio/report_${reportId}_${Date.now()}.webm`;
            const { error: uploadError } = await sb.storage
                .from('autofix-media')
                .upload(filePath, recordedAudioBlob);

            if (uploadError) throw uploadError;

            const { data: urlData } = sb.storage.from('autofix-media').getPublicUrl(filePath);
            audioUrlToUpload = urlData.publicUrl;
        } catch(uploadError) {
            showError('Failed to upload voice note. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<span class="material-symbols-outlined">task_alt</span> Submit Approval`;
            return;
        }
    }
    
    const updateData = {
        approved: JSON.stringify(allApprovedItems), // Now an array of objects
        customer_feedback_text: feedbackText || null,
        customer_feedback_audio: audioUrlToUpload,
        status: 'Ongoing'
    };

    const { error } = await sb.from('reports').update(updateData).eq('id', reportId);

    if (error) {
        showError(`Failed to submit approval: ${error.message}`);
        submitBtn.disabled = false;
        submitBtn.innerHTML = `<span class="material-symbols-outlined">task_alt</span> Submit Approval`;
        return;
    }
    
    document.getElementById('customer-approval-content').classList.add('hidden');
    document.getElementById('customer-thank-you').classList.remove('hidden');
}


        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const reportIdFromUrl = urlParams.get('report_id');
            
            if (reportIdFromUrl) {
                initializeCustomerView(reportIdFromUrl);
            } else {
                 document.getElementById('customer-loading').innerHTML = `<p class="text-red-500 font-bold">Error: No report ID was found in the link.</p>`;
            }
        });
    </script>
</body>
</html>

